---
title: "Evoluci√≥n territorial del voto por Gustavo Petro en el Magdalena"
subtitle: "Elecciones presidenciales 2018‚Äì2022"
author: 
  - "Centro de Investigaci√≥n en Econom√≠a y Finanzas (CIENFI)"
  - "Universidad Icesi"
lang: es
format: 
  html:
    self-contained: true
    number-sections: true
    code-fold: false
    code-tools: false
    toc: true
    toc-depth: 3
    toc-location: left
    theme: cosmo
    fontsize: 18px
    page-layout: full
    df-print: paged
    smooth-scroll: true
    embed-resources: true
execute:
  echo: false
  warning: false
  message: false
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 10)
```

```{r librerias}
# Cargar librer√≠as
library(tidyverse)
library(rio)
library(sf)
library(leaflet)
library(crosstalk)
library(DT)
library(scales)
library(htmltools)
library(plotly)
library(kableExtra)
library(patchwork)
library(ggrepel)
library(dplyr)
```

```{r cargar_datos_procesados}
# ============================================================================
# CARGAR TODOS LOS OUTPUTS DE LOS PASOS ANTERIORES
# ============================================================================

# Datos preparados
#datos_comparacion <- readRDS(
#  file.path("..", "02_prepare", "output", "datos_comparacion.rds")
#)

# Ruta relativa segura
datos_comparacion <- readRDS("../02_prepare/output/datos_comparacion.rds")

datos_mapa <- readRDS(
  file.path("..", "02_prepare", "output", "datos_mapa.rds")
)

```

::: {.callout-tip appearance="minimal" title="Resumen"}
Este informe presenta un an√°lisis comparativo de los resultados electorales en el departamento del Magdalena para las elecciones presidenciales de **2018** y **2022**, con √©nfasis en la **evoluci√≥n territorial del voto de Gustavo Petro** entre ambos ciclos electorales.

El analis muestra c√≥mo cambiaron los patrones de apoyo en **primera** y **segunda vuelta**, y contrasta estas din√°micas con los candidatos que disputaron la segunda vuelta en cada elecci√≥n: Iv√°n Duque (2018) y Rodolfo Hern√°ndez (2022).

A partir de informaci√≥n desagregada por puesto de votaci√≥n, se identifican variaciones espaciales en la intensidad del voto, cambios en la participaci√≥n y reconfiguraciones del mapa electoral departamental, con el fin de aportar evidencia clara y √∫til para el an√°lisis pol√≠tico y territorial.
:::

# An√°lisis Municipal

El Magdalena se divide en **30 municipios**, con Santa Marta como su principal centro urbano, concentrando gran parte de la poblaci√≥n y del electorado. Entre 2018 y 2022, el apoyo a Gustavo Petro **creci√≥ de manera notable**, destacando municipios clave como Santa Marta (50.8% ‚Üí 62.2%), Ariguan√≠ (35.2% ‚Üí 49.2%) y Cerro de San Antonio (28.1% ‚Üí 51.8%).

El mapa permite explorar los resultados por municipio y visualizar c√≥mo se intensific√≥ el respaldo. Se observa una **consolidaci√≥n del voto en el norte y centro** del departamento ‚ÄîAracataca, Pivijay, Sitionuevo y El Ret√©n superan el 60%‚Äî mientras que en el sur, municipios como Santa Ana, Guamal y Zapay√°n muestran incrementos m√°s moderados, con apoyo a√∫n por debajo del 40%. Este patr√≥n evidencia un **voto territorialmente desigual**, con zonas estrat√©gicas de mayor intensidad electoral.

::: panel-tabset
## Segunda vuelta

```{r}
# Cargar mapas de Magdalena
magdalena_map_1 <- readRDS("../03_figures/output/magdalena_map_2018.rds")
magdalena_map_2 <- readRDS("../03_figures/output/magdalena_map_2022.rds")

# Definir colores rojos
colores_rojos <- c(
  "0-20%"  = "#fff5f0",
  "20-30%" = "#fee0d2",
  "30-40%" = "#fcbba1",
  "40-50%" = "#fc9272",
  ">50%"   = "#fb6a4a"
)

# Categorizar votos (si no lo has hecho)
categorizar_votos <- function(df) {
  df %>%
    mutate(prop_cat = case_when(
      prop_mpio < 0.2 ~ "0-20%",
      prop_mpio >= 0.2 & prop_mpio < 0.3 ~ "20-30%",
      prop_mpio >= 0.3 & prop_mpio < 0.4 ~ "30-40%",
      prop_mpio >= 0.4 & prop_mpio < 0.5 ~ "40-50%",
      prop_mpio >= 0.5 ~ ">50%"
    )) %>%
    mutate(prop_cat = factor(prop_cat,
                             levels = c("0-20%", "20-30%", "30-40%", "40-50%", ">50%")))
}

magdalena_map_1 <- categorizar_votos(magdalena_map_1)
magdalena_map_2 <- categorizar_votos(magdalena_map_2)

pal <- colorFactor(
  palette = colores_rojos,
  domain = magdalena_map_1$prop_cat
)

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    data = magdalena_map_1,
    fillColor = ~pal(prop_cat),
    color = "black",
    weight = 1,
    fillOpacity = 0.7,
    label = ~mpio_label,
    group = "2018",
    highlight = highlightOptions(
      weight = 3,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addPolygons(
    data = magdalena_map_2,
    fillColor = ~pal(prop_cat),
    color = "black",
    weight = 1,
    fillOpacity = 0.7,
    label = ~mpio_label,
    group = "2022",
    highlight = highlightOptions(
      weight = 3,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addLegend(
    "bottomright",
    colors = colores_rojos,
    labels = names(colores_rojos),
    title = "Proporci√≥n de votos"
  ) %>%
  addLayersControl(
    baseGroups = c("2018", "2022"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  hideGroup("2022")
```
:::

## Participaci√≥n Electoral

Entre 2018 y 2022, los habitantes del Magdalena salieron a votar m√°s: la participaci√≥n creci√≥ un **14.6% en primera vuelta** (de 404 mil a 463 mil votos) y un **21.4% en segunda vuelta** (de 418 mil a 508 mil). En este periodo, *el apoyo a Gustavo Petro registr√≥ un crecimiento a√∫n m√°s notable*. En primera vuelta, pas√≥ de captar **uno de cada tres votos (34%)** a casi **la mitad (49%)**. En segunda vuelta, el avance fue m√°s contundente: pas√≥ del **46% al 60%**. As√≠, en apenas cuatro a√±os, Petro pas√≥ de ser un candidato que *compet√≠a activamente en la contienda* a consolidarse como la **opci√≥n dominante en el departamento**.

```{r resumen_general}
# Calcular totales del departamento
total_votos_v1_2018 <- sum(datos_comparacion$t_votos_v1_2018, na.rm = TRUE)
total_votos_v2_2018 <- sum(datos_comparacion$t_votos_v2_2018, na.rm = TRUE)
total_votos_v1_2022 <- sum(datos_comparacion$t_votos_v1_2022, na.rm = TRUE)
total_votos_v2_2022 <- sum(datos_comparacion$t_votos_v2_2022, na.rm = TRUE)

# Calcular votos de Petro
petro_v1_2018 <- sum(datos_comparacion$Petro_v1_2018, na.rm = TRUE)
petro_v2_2018 <- sum(datos_comparacion$Petro_v2_2018, na.rm = TRUE)
petro_v1_2022 <- sum(datos_comparacion$Petro_v1_2022, na.rm = TRUE)
petro_v2_2022 <- sum(datos_comparacion$Petro_v2_2022, na.rm = TRUE)

# Crear tabla de participaci√≥n electoral
resumen <- tibble(
  Indicador = c(
    "Total Votos 2018 - Primera Vuelta",
    "Total Votos 2018 - Segunda Vuelta",
    "Total Votos 2022 - Primera Vuelta",
    "Total Votos 2022 - Segunda Vuelta"
  ),
  Valor = c(
    total_votos_v1_2018,
    total_votos_v2_2018,
    total_votos_v1_2022,
    total_votos_v2_2022
  ),
  `Proporci√≥n Petro (%)` = c(
    (petro_v1_2018 / total_votos_v1_2018) * 100,
    (petro_v2_2018 / total_votos_v2_2018) * 100,
    (petro_v1_2022 / total_votos_v1_2022) * 100,
    (petro_v2_2022 / total_votos_v2_2022) * 100
  )
)

resumen %>% 
  mutate(
    Valor = comma(Valor),
    `Proporci√≥n Petro (%)` = paste0(round(`Proporci√≥n Petro (%)`, 2), "%")
  ) %>% 
  kbl(align = c("l", "r", "r")) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover"),
    full_width = FALSE,
    position = "left",
    font_size = 12
  ) %>% 
  column_spec(1, bold = TRUE, width = "18em") %>% 
  column_spec(2, width = "8em") %>% 
  column_spec(3, width = "10em", color = "white", background = "#3498db") %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50")
```

## Petro frente a sus contrincantes

Petro sum√≥ m√°s de **90 mil votos nuevos en primera vuelta (+67%)** y cerca de **110 mil en segunda vuelta (+58%)** entre ambas elecciones. Sus rivales, en cambio, *perdieron fuerza*. Duque obtuvo 152 mil votos en la primera vuelta de 2018; Hern√°ndez apenas lleg√≥ a **78 mil en 2022**, una ca√≠da del **49%**. En segunda vuelta la p√©rdida se mantuvo: Hern√°ndez recibi√≥ **22 mil votos menos** que Duque cuatro a√±os atr√°s (-10%).

El contraste es claro: mientras Petro *expandi√≥ su base electoral en ambas vueltas*, la coalici√≥n opositora se contrajo en primera vuelta y no logr√≥ recuperarse del todo en la definici√≥n. El Magdalena no solo vot√≥ m√°s por Petro; vot√≥ *decididamente menos por sus opositores*.

```{r tabla_agregada_mejorada}
# Crear tabla resumen con m√©tricas adicionales
tabla_magdalena_larga <- tibble(
  Regi√≥n = rep("Magdalena", 4),
  Candidato = c("Gustavo Petro", "Gustavo Petro", 
                "Contrincante (Duque 2018 / Hern√°ndez 2022)", 
                "Contrincante (Duque 2018 / Hern√°ndez 2022)"),
  Vuelta = rep(c("Primera Vuelta", "Segunda Vuelta"), 2),
  
  `2018` = c(
    sum(datos_comparacion$Petro_v1_2018, na.rm = TRUE),
    sum(datos_comparacion$Petro_v2_2018, na.rm = TRUE),
    sum(datos_comparacion$Duque_v1_2018, na.rm = TRUE),
    sum(datos_comparacion$Duque_v2_2018, na.rm = TRUE)
  ),
  
  `2022` = c(
    sum(datos_comparacion$Petro_v1_2022, na.rm = TRUE),
    sum(datos_comparacion$Petro_v2_2022, na.rm = TRUE),
    sum(datos_comparacion$Hernandez_v1_2022, na.rm = TRUE),
    sum(datos_comparacion$Hernandez_v2_2022, na.rm = TRUE)
  )
) %>%
  mutate(
    `Œî Absoluta` = `2022` - `2018`,
    `Œî %` = ((`2022` - `2018`) / `2018`) * 100
  )

# Mostrar tabla formateada
tabla_magdalena_larga %>%
  mutate(
    `2018` = comma(`2018`),
    `2022` = comma(`2022`),
    `Œî Absoluta` = paste0(ifelse(`Œî Absoluta` > 0, "+", ""), comma(`Œî Absoluta`)),
    `Œî %` = paste0(ifelse(`Œî %` > 0, "+", ""), round(`Œî %`, 2), "%")
  ) %>%
  knitr::kable(
    align = c("l", "l", "l", "r", "r", "r", "r")
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered")) %>%
  row_spec(1:2, background = "#d4edda") %>%  # Color suave para Petro
  row_spec(3:4, background = "#f8d7da")      # Color suave para contrincantes
```

## Resultados por municipio

Los 30 municipios del Magdalena muestran trayectorias diversas, pero con un patr√≥n com√∫n: *en 2022 Petro gan√≥ votos en todas las ciudades respecto a la elecci√≥n anterior*. Las diferencias est√°n en la magnitud. Concordia ‚Äîubicado al noroccidente‚Äî increment√≥ en m√°s del doble el apoyo al candidato en primera vuelta; *San Zen√≥n, en cambio, apenas creci√≥ un 15%*. Santa Marta, con su volumen electoral, aport√≥ **m√°s de 15 mil votos nuevos** en primera vuelta, aunque su crecimiento porcentual fue modesto comparado con municipios m√°s peque√±os.

Lo interesante est√° en la *columna de participaci√≥n*: algunos municipios que aumentaron su votaci√≥n por Petro tambi√©n crecieron significativamente en participaci√≥n total (*Sitionuevo +49%*), mientras otros mantuvieron o incluso redujeron sus niveles de votaci√≥n, *pero redistribuyeron sus preferencias hacia √©l*.

```{r tabla_municipios_detallada}
resumen_municipios <- datos_comparacion %>% 
  filter(ambos) %>% 
  group_by(mpio) %>% 
  summarise(
    `N¬∞ Puestos` = n(),
    
    # Petro Primera Vuelta
    `Petro 2018 V1` = sum(Petro_v1_2018, na.rm = TRUE),
    `Petro 2022 V1` = sum(Petro_v1_2022, na.rm = TRUE),
    `Œî Abs V1` = `Petro 2022 V1` - `Petro 2018 V1`,
    `Œî % V1` = ((`Petro 2022 V1` - `Petro 2018 V1`) / `Petro 2018 V1`) * 100,
    
    # Petro Segunda Vuelta
    `Petro 2018 V2` = sum(Petro_v2_2018, na.rm = TRUE),
    `Petro 2022 V2` = sum(Petro_v2_2022, na.rm = TRUE),
    `Œî Abs V2` = `Petro 2022 V2` - `Petro 2018 V2`,
    `Œî % V2` = ((`Petro 2022 V2` - `Petro 2018 V2`) / `Petro 2018 V2`) * 100,
    
    # Participaci√≥n
    `Part. Œî %` = mean(var_participacion_v2, na.rm = TRUE)
  ) %>% 
  arrange(desc(`Œî Abs V2`))

# Funci√≥n para aplicar color condicional
color_var <- function(x) {
  case_when(
    x > 0 ~ "#27ae60",   # Verde
    x < 0 ~ "#c0392b",   # Rojo
    TRUE ~ "#2c3e50"     # Gris oscuro
  )
}

resumen_municipios %>% 
  mutate(
    across(c(`Petro 2018 V1`, `Petro 2022 V1`, `Œî Abs V1`,
             `Petro 2018 V2`, `Petro 2022 V2`, `Œî Abs V2`), ~comma(.x)),
    `Œî % V1` = paste0(ifelse(`Œî % V1` > 0, "+", ""), round(`Œî % V1`, 1), "%"),
    `Œî % V2` = paste0(ifelse(`Œî % V2` > 0, "+", ""), round(`Œî % V2`, 1), "%"),
    `Part. Œî %` = paste0(ifelse(`Part. Œî %` > 0, "+", ""), round(`Part. Œî %`, 1), "%")
  ) %>% 
  kbl(align = c("l", rep("r", 10))) %>% 
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    position = "left",
    font_size = 13
  ) %>% 
  column_spec(1, bold = TRUE, width = "12em") %>% 
  column_spec(6, 
    color = spec_color(resumen_municipios$`Œî % V1`, 
                       begin = 0.3, end = 0.9, 
                       option = "D", direction = 1)
  ) %>% 
  column_spec(10, 
    color = spec_color(resumen_municipios$`Œî % V2`, 
                       begin = 0.3, end = 0.9, 
                       option = "D", direction = 1)
  ) %>% 
  column_spec(11, 
    color = spec_color(resumen_municipios$`Part. Œî %`, 
                       begin = 0.3, end = 0.9, 
                       option = "D", direction = 1)
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  scroll_box(width = "100%", height = "500px")
```

------------------------------------------------------------------------

# An√°lisis a Nivel Puesto de Votaci√≥n

Para 2022, el Magdalena cont√≥ con **358 puestos de votaci√≥n** habilitados por la Registradur√≠a, distribuidos en sus 30 municipios. Santa Marta concentra **60 de ellos**, casi la quinta parte del total departamental, reflejando su peso demogr√°fico como capital. Le siguen El Banco con 27 puestos, Guamal con 23, Ci√©naga con 21 y Plato con 20. En el otro extremo est√°n municipios como *Salamina con apenas 2 puestos*, El Ret√©n con 3, y Algarrobo y Concordia con 4 cada uno.

Esta distribuci√≥n marca diferencias importantes en c√≥mo se lee el voto. En *municipios peque√±os*, un solo puesto puede definir el resultado municipal completo. En Santa Marta, en cambio, la diversidad de puestos permite identificar **patrones espaciales m√°s finos**, que empiezan a mostrar d√≥nde exactamente ocurrieron los cambios en los resultados electorales y qu√© caracter√≠sticas territoriales podr√≠an estar asociadas.

## Correlaci√≥n de Votos 2018 vs 2022

Este gr√°fico compara puesto por puesto el desempe√±o de Petro en segunda vuelta entre ambas elecciones. Cada punto representa un puesto de votaci√≥n: en el eje horizontal est√° su votaci√≥n en 2018, en el vertical la de 2022. La l√≠nea punteada marca el equilibrio: si un puesto cayera exactamente sobre ella, significar√≠a que Petro obtuvo los mismos votos en ambos a√±os.

Salta a la vista que **la mayor√≠a de puntos se ubican por encima de esa l√≠nea**. Petro creci√≥ en pr√°cticamente todos los puestos del departamento. Los puntos en *verde m√°s intenso* marcan los crecimientos m√°s pronunciados: puestos donde duplic√≥ o incluso triplic√≥ su votaci√≥n. Los pocos puntos rosados, ubicados bajo la l√≠nea, se√±alan las excepciones: lugares donde *perdi√≥ votos* entre una elecci√≥n y otra.

La nube de puntos tambi√©n muestra una correlaci√≥n positiva: los puestos donde Petro ya era fuerte en 2018 tendieron a crecer a√∫n m√°s en 2022, consolidando bastiones. Pero incluso en territorios donde part√≠a de votaciones bajas logr√≥ sumar.

```{r correlacion_petro_interactivo, echo=FALSE}
library(plotly)

p <- datos_comparacion %>% 
  filter(ambos) %>% 
  ggplot(
    aes(
      x = Petro_v2_2018,
      y = Petro_v2_2022,
      text = paste0(
        "<b>Puesto:</b> ", puesto_nom, "<br>",
        "<b>Municipio:</b> ", mpio, "<br>",
        "<b>Votos 2018:</b> ", comma(Petro_v2_2018), "<br>",
        "<b>Votos 2022:</b> ", comma(Petro_v2_2022), "<br>",
        "<b>Variaci√≥n (%):</b> ", round(var_Petro_v2, 1)
      )
    )
  ) +
  geom_point(
    aes(color = var_Petro_v2, size = t_votos_v2_2022),
    alpha = 0.85,
    stroke = 0.4
  ) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black") +
  scale_color_gradient2(
    low = "#8B0000",      # rojo fuerte
    mid = "#FFFFFF",      # blanco puro
    high = "#003300",     # verde oscuro
    midpoint = 0
  ) +
  scale_size_continuous(range = c(4, 10)) +
  labs(
    x = "Votos Petro 2018 (2da vuelta)",
    y = "Votos Petro 2022 (2da vuelta)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank()
  )

ggplotly(p, tooltip = "text")

```

## Mayores Ganancias de Petro

Estos diez puestos registraron las mayores variaciones absolutas en el voto por Petro al comparar las rondas finales de 2018 y 2022. El *megacolegio Aluna Cisne* en Santa Marta lidera: pas√≥ de 1.189 votos a 3.608, sumando 2.419 votos nuevos (+203%). Le sigue la *cabecera* del municipio El Ret√©n con un incremento de 2.276 votos, y el *colegio T√©cnico Sim√≥n Bol√≠var de Mamatoco* con cerca de 2.000 votos adicionales.

La geograf√≠a de estas ganancias muestra lo siguiente: **siete de los diez puestos est√°n en Santa Marta**, concentrados en colegios de barrios populares y zonas de expansi√≥n urbana. Los otros tres corresponden a cabeceras municipales (El Ret√©n y Sitionuevo) y a instituciones educativas en Ci√©naga y Fundaci√≥n. Son territorios con *alta densidad de votantes*, donde peque√±os movimientos en preferencias se traducen en miles de votos.

```{r top_ganancias}
datos_comparacion %>% 
  filter(ambos, !is.na(var_abs_Petro_v2)) %>% 
  arrange(desc(var_abs_Petro_v2)) %>% 
  head(10) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `2018` = Petro_v2_2018,
    `2022` = Petro_v2_2022,
    `Ganancia` = var_abs_Petro_v2,
    `Var %` = var_Petro_v2
  ) %>% 
  mutate(
    across(c(`2018`, `2022`, Ganancia), ~comma(.x)),
    `Var %` = paste0("+", round(`Var %`, 1), "%")
  ) %>% 
  kbl(align = c("l", "l", rep("r", 4))) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover"),
    full_width = FALSE,
    font_size = 12
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#27ae60") %>% 
  column_spec(1:2, bold = TRUE, width = "10em") %>% 
  column_spec(3:6, width = "7em")
```

## Mayores P√©rdidas de Petro

No todo fue crecimiento. Estos diez puestos registraron las mayores p√©rdidas absolutas en el voto por Petro entre las rondas finales en cada elecci√≥n. Los siguientes corresponden a los diez puestos en los que Petro registr√≥ p√©rdidas de votos entre 2018 y 2022. Nueve de ellos est√°n en Santa Marta, concentrados principalmente en colegios del centro y el norte de la ciudad. El *IED John F. Kennedy* registr√≥ la mayor ca√≠da: pas√≥ de 2.551 votos a apenas 94 (-96%). Le sigue la *Normal Superior San Pedro* con una p√©rdida de 2.078 votos (-34%), y el *Liceo del Norte* con 1.027 votos menos (-25,5%).

El √∫nico puesto fuera de Santa Marta es el *Parque 7 de Agosto* en Fundaci√≥n, que cedi√≥ 414 votos (-19,5%). Vale la pena notar que varios de estos puestos, a pesar de las p√©rdidas, mantienen votaciones absolutas altas por Petro: *El Pando* con 5.080, *El Parque* con 4.861 y la *Normal Superior* con 4.013. No -necesariamente- son territorios que le quitaron su apoyo, sino lugares donde su votaci√≥n se contrajo, mientras que, en pr√°cticamente todo el resto del departamento crec√≠a de forma sostenida. Que las p√©rdidas se concentren geogr√°ficamente en Santa Marta sugiere din√°micas locales de la capital, distintas al patr√≥n de expansi√≥n generalizada que caracteriz√≥ al resto del Magdalena.

```{r top_perdidas}
datos_comparacion %>% 
  filter(ambos, !is.na(var_abs_Petro_v2)) %>% 
  arrange(var_abs_Petro_v2) %>% 
  head(10) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `2018` = Petro_v2_2018,
    `2022` = Petro_v2_2022,
    `P√©rdida` = var_abs_Petro_v2,
    `Var %` = var_Petro_v2
  ) %>% 
  mutate(
    across(c(`2018`, `2022`, P√©rdida), ~comma(.x)),
    `Var %` = paste0(round(`Var %`, 1), "%")
  ) %>% 
  kbl(align = c("l", "l", rep("r", 4))) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover"),
    full_width = FALSE,
    font_size = 12
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#c0392b") %>% 
  column_spec(1:2, bold = TRUE, width = "10em") %>% 
  column_spec(3:6, width = "7em")
```

## Puestos que Cambiaron de Ganador entre elecciones (Flips)

La tabla muestra los puestos que cambiaron de ganador entre 2018 y 2022, tanto en primera como en segunda vuelta. Aracataca es un caso emblem√°tico: de 13 puestos, 11 que hab√≠a ganado Duque en 2018 viraron a Petro en 2022. En Ci√©naga, ocho puestos que fueron de Duque pasaron a manos de Petro, consolidando el dominio petrista en la ciudad.

El patr√≥n se repite en Zona Bananera, Fundaci√≥n, Puebloviejo y Santa Marta, donde decenas de colegios y corregimientos que votaron mayoritariamente por Duque en 2018 eligieron a Petro cuatro a√±os despu√©s. Algunos cambios son particularmente llamativos: en Concordia, puestos que hab√≠an votado por Vargas Lleras en primera vuelta de 2018 pasaron directamente a Petro en 2022.

Pero no todo el mapa vir√≥ hacia Petro. En municipios como El Banco, Guamal, Piji√±o del Carmen y San Sebasti√°n de Buenavista, varios puestos que gan√≥ Duque en 2018 no fueron para Petro sino para Federico Guti√©rrez en 2022 (primera vuelta). Rodolfo Hern√°ndez logr√≥ sostener algunos territorios que Duque hab√≠a ganado ‚Äîcomo en Santa Ana o Sabanas de San √Ångel‚Äî, aunque en general no consigui√≥ retener la coalici√≥n uribista.

```{r analisis_flips}
# Tabla de flips - CONSIDERANDO TODOS LOS CANDIDATOS
flips_completa <- datos_comparacion %>% 
  filter(ambos) %>% 
  mutate(
    # Determinar si Petro gan√≥ en todas las vueltas de ambas elecciones
    petro_gano_todas = (ganador_v1_2018 == "Petro" & ganador_v2_2018 == "Petro" &
                        ganador_v1_2022 == "Petro" & ganador_v2_2022 == "Petro"),
    # Determinar si Petro no gan√≥ en ninguna
    petro_perdio_todas = (ganador_v1_2018 != "Petro" & ganador_v2_2018 != "Petro" &
                          ganador_v1_2022 != "Petro" & ganador_v2_2022 != "Petro")
  ) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `2018 V1` = ganador_v1_2018,
    `2018 V2` = ganador_v2_2018,
    `2022 V1` = ganador_v1_2022,
    `2022 V2` = ganador_v2_2022,
    petro_gano_todas,
    petro_perdio_todas
  ) %>% 
  arrange(Municipio, Puesto)

# Crear √≠ndices para colorear filas
idx_petro_todas <- which(flips_completa$petro_gano_todas)
idx_petro_ninguna <- which(flips_completa$petro_perdio_todas)

# Tabla principal
flips_completa %>% 
  select(-petro_gano_todas, -petro_perdio_todas) %>% 
  kbl(align = c("l", "l", rep("c", 4))) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover", "striped"),
    full_width = FALSE,
    font_size = 11
  ) %>% 
  column_spec(1, bold = TRUE, width = "10em") %>% 
  column_spec(2, width = "15em") %>% 
  column_spec(3:6, width = "7em") %>% 
  add_header_above(c(" " = 2, "Ganador 2018" = 2, "Ganador 2022" = 2)) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  row_spec(idx_petro_todas, background = "#c8e6c9", bold = TRUE) %>% 
  row_spec(idx_petro_ninguna, background = "#ffcdd2") %>% 
  scroll_box(width = "100%", height = "600px")
```

## Mirada espacial de los votos

Este mapa interactivo geolocaliza los puestos de votaci√≥n del Magdalena y muestra visualmente c√≥mo cambi√≥ el voto por Petro en segunda vuelta entre ambas elecciones. Cada c√≠rculo representa un puesto: su tama√±o es proporcional a la participaci√≥n electoral en 2022 (mientras mayor el n√∫mero de votantes, m√°s grande el punto), y su color indica la magnitud del cambio.

El verde domina el mapa. Los puntos en *üü¢ verde oscuro (50% o m√°s)* corresponden a los puestos donde Petro duplic√≥ o triplic√≥ su votaci√≥n. El *üü¢ verde claro (25% a 50%)* se√±ala crecimientos moderados pero significativos. El *üü° amarillo (-25% a 25%)* indica estabilidad relativa. Los pocos puntos en *üü† naranja (-50% a -25%)* y *üî¥ rojo oscuro (-50% o m√°s)*, concentrados principalmente en Santa Marta, muestran las p√©rdidas m√°s relevantes. Los puntos en *‚ö´ gris* corresponden a puestos sin informaci√≥n comparable.

Geogr√°ficamente, el crecimiento fue generalizado pero con intensidades distintas. La zona norte del departamento (Santa Marta, Ci√©naga, Zona Bananera) muestra una mezcla de verdes claros y oscuros con algunos amarillos, reflejando procesos de consolidaci√≥n en territorios ya fuertes. El centro y sur (municipios como Aracataca, Fundaci√≥n, Plato y El Banco) presentan predominio de verdes intermedios, lo que indica expansiones relativas m√°s altas en zonas donde Petro part√≠a de bases electorales m√°s d√©biles en 2018.

El mapa es interactivo: se puede hacer clic en cualquier punto para observar el detalle de cada puesto espec√≠fico, y filtrar por municipio usando el selector superior, lo que permite identificar patrones locales con mayor precisi√≥n.

```{r mapa_interactivo, fig.height=10}
# Calcular tama√±os de radio proporcionales a participaci√≥n
datos_mapa <- datos_mapa %>% 
  mutate(
    # Usar votos de segunda vuelta 2022 (o 2018 si no hay 2022)
    votos_referencia = coalesce(t_votos_v2_2022, t_votos_v2_2018, 0),
    # Escalar radius entre 4 y 18 basado en participaci√≥n (ra√≠z cuadrada para mejor visualizaci√≥n)
    radius_scaled = scales::rescale(sqrt(votos_referencia), to = c(4, 18))
  )

# Preparar datos para crosstalk
datos_compartidos <- SharedData$new(
  datos_mapa %>% 
    mutate(
      mpio = ifelse(is.na(mpio), "Sin municipio", mpio),
      puesto_nom = ifelse(is.na(puesto_nom), "Sin nombre", puesto_nom)
    ),
  key = ~id_puesto
)

# Paleta de colores con rangos
pal <- colorBin(
  palette = c("#d73027", "#fc8d59", "#fee08b", "#d9ef8b", "#91cf60", "#1a9850"),
  domain = datos_mapa$var_Petro_v2,
  bins = c(-Inf,-50, -25, 25, 50, 100, Inf),
  na.color = "#808080"
)

# Filtro por municipio
filter_select(
  id = "municipio",
  label = "Selecciona municipio:",
  sharedData = datos_compartidos,
  group = ~mpio,
  multiple = TRUE
)

# Crear el mapa con fondo claro, m√°s grande y puntos proporcionales
leaflet(datos_compartidos, height = 750, width = "100%") %>% 
  # Usar CartoDB Positron para fondo minimalista y claro
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    lng = ~lon,
    lat = ~lat,
    radius = ~radius_scaled,  # Radio variable seg√∫n participaci√≥n
    color = "#2c3e50",  # Borde oscuro para mejor contraste
    fillColor = ~pal(var_Petro_v2),
    fillOpacity = 0.7,
    stroke = TRUE,
    weight = 1.5,
    opacity = 0.9,
    popup = ~paste0(
      "<div style='width:520px; background-color:#ffffff; padding:15px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15);'>",
      "<h4 style='margin:0 0 10px 0; color:#2c3e50; border-bottom:2px solid #3498db; padding-bottom:8px;'><strong>", puesto_nom, "</strong></h4>",
      "<p style='margin:5px 0; font-size:13px;'><strong>Municipio:</strong> ", mpio, "</p>",
      "<p style='margin:5px 0; font-size:13px;'><strong>ID:</strong> ", id_puesto, "</p>",
      
      ifelse(solo_2018, 
        "<div style='margin:10px 0; padding:10px; background-color:#fff3cd; border-left:4px solid #ffc107; border-radius:4px;'><strong>‚ö†Ô∏è Solo datos 2018</strong></div>",
        ifelse(solo_2022,
          "<div style='margin:10px 0; padding:10px; background-color:#d1ecf1; border-left:4px solid #17a2b8; border-radius:4px;'><strong>‚ÑπÔ∏è Solo datos 2022</strong></div>",
          "")),
      
      "<hr style='margin:15px 0; border:none; border-top:1px solid #ddd;'>",
      
      "<table style='width:100%; border-collapse: collapse; font-size:12px; background-color:#ffffff;'>",
      "<thead>",
      "<tr style='background-color:#34495e; color:white;'>",
      "<th colspan='4' style='padding:10px; text-align:center; border:1px solid #bdc3c7; font-size:13px;'>GUSTAVO PETRO</th>",
      "</tr>",
      "<tr style='background-color:#ecf0f1;'>",
      "<th style='padding:6px; border:1px solid #bdc3c7; font-weight:bold;'></th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>2018</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>2022</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Œî</th>",
      "</tr>",
      "</thead>",
      "<tbody style='background-color:#ffffff;'>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>1¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v1_2018), comma(Petro_v1_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v1_2022), comma(Petro_v1_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Petro_v1) & var_Petro_v1 > 0, "#27ae60", 
               ifelse(!is.na(var_Petro_v1) & var_Petro_v1 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Petro_v1), paste0(ifelse(var_Petro_v1 > 0, "+", ""), round(var_Petro_v1, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>2¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v2_2018), comma(Petro_v2_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v2_2022), comma(Petro_v2_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Petro_v2) & var_Petro_v2 > 0, "#27ae60", 
               ifelse(!is.na(var_Petro_v2) & var_Petro_v2 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Petro_v2), paste0(ifelse(var_Petro_v2 > 0, "+", ""), round(var_Petro_v2, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "</tbody>",
      "</table>",
      
      "<div style='height:12px;'></div>",
      
      "<table style='width:100%; border-collapse: collapse; font-size:12px; background-color:#ffffff;'>",
      "<thead>",
      "<tr style='background-color:#c0392b; color:white;'>",
      "<th colspan='4' style='padding:10px; text-align:center; border:1px solid #bdc3c7; font-size:13px;'>CONTRINCANTES</th>",
      "</tr>",
      "<tr style='background-color:#ecf0f1;'>",
      "<th style='padding:6px; border:1px solid #bdc3c7; font-weight:bold;'></th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Duque 2018</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Hern√°ndez 2022</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Œî</th>",
      "</tr>",
      "</thead>",
      "<tbody style='background-color:#ffffff;'>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>1¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Duque_v1_2018), comma(Duque_v1_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Hernandez_v1_2022), comma(Hernandez_v1_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Contrincante_v1) & var_Contrincante_v1 > 0, "#27ae60", 
               ifelse(!is.na(var_Contrincante_v1) & var_Contrincante_v1 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Contrincante_v1), paste0(ifelse(var_Contrincante_v1 > 0, "+", ""), round(var_Contrincante_v1, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>2¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Duque_v2_2018), comma(Duque_v2_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Hernandez_v2_2022), comma(Hernandez_v2_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Contrincante_v2) & var_Contrincante_v2 > 0, "#27ae60", 
               ifelse(!is.na(var_Contrincante_v2) & var_Contrincante_v2 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Contrincante_v2), paste0(ifelse(var_Contrincante_v2 > 0, "+", ""), round(var_Contrincante_v2, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "</tbody>",
      "</table>",
      
      "<hr style='margin:15px 0; border:none; border-top:1px solid #ddd;'>",
      "<p style='font-size:11px; color:#7f8c8d; margin:0; padding:8px; background-color:#f8f9fa; border-radius:4px;'><strong>Participaci√≥n Œî:</strong> ",
      ifelse(!is.na(var_participacion_v2), 
        paste0(ifelse(var_participacion_v2 > 0, "+", ""), round(var_participacion_v2, 1), "% (2¬™ vuelta)"), 
        "N/A"),
      "</p>",
      
      "</div>"
    ),
    label = ~puesto_nom
  ) %>% 
  addLegend(
  position = "bottomright",
  pal = pal,
  values = ~var_Petro_v2,
  title = "Variaci√≥n Petro<br>2¬™ Vuelta (%)",
  opacity = 0.8,
  labFormat = function(type, cuts, p) {
    cuts <- as.numeric(cuts)

    paste0(
      ifelse(is.infinite(cuts[-length(cuts)]),
             ifelse(cuts[-length(cuts)] < 0, "< ", ""),
             cuts[-length(cuts)]),
      " ‚Äì ",
      ifelse(is.infinite(cuts[-1]),
             ifelse(cuts[-1] > 0, "> ", ""),
             cuts[-1]),
      "%"
    )
  },
  na.label = "Sin datos"
)

```

## Resultados por puestos de votaci√≥n

```{r tabla_datos_completa, results='asis'}

tabla_puestos <- datos_mapa %>% 
  st_drop_geometry() %>% 
  filter(ambos) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `Petro 2018 V1` = Petro_v1_2018,
    `Petro 2022 V1` = Petro_v1_2022,
    `Œî % V1` = var_Petro_v1,
    `Petro 2018 V2` = Petro_v2_2018,
    `Petro 2022 V2` = Petro_v2_2022,
    `Œî % V2` = var_Petro_v2,
    `Part. Œî %` = var_participacion_v2
  )

valores_color <- tabla_puestos %>% 
  select(`Œî % V1`, `Œî % V2`, `Part. Œî %`) %>% 
  unlist()

# Recorte robusto (percentil 95)
max_abs <- quantile(abs(valores_color), 0.95, na.rm = TRUE)

color_grad <- function(x) {
  
  intensidad <- abs(x) / max_abs
  intensidad <- pmin(intensidad, 1)        # truncar extremos
  intensidad <- 0.35 + 0.65 * intensidad   # piso m√≠nimo 35%
  
  ifelse(
    x > 0,
    col_numeric(c("#66bb6a", "#006400"), domain = c(0.35,1))(intensidad),
    col_numeric(c("#ef5350", "#8B0000"), domain = c(0.35,1))(intensidad)
  )
}

tabla_puestos %>% 
  mutate(
    across(contains("2018") | contains("2022"), ~comma(.x)),
    `Œî % V1` = cell_spec(
      paste0(ifelse(`Œî % V1` > 0, "+", ""), round(`Œî % V1`, 1), "%"),
      color = color_grad(tabla_puestos$`Œî % V1`),
      bold = TRUE
    ),
    `Œî % V2` = cell_spec(
      paste0(ifelse(`Œî % V2` > 0, "+", ""), round(`Œî % V2`, 1), "%"),
      color = color_grad(tabla_puestos$`Œî % V2`),
      bold = TRUE
    ),
    `Part. Œî %` = cell_spec(
      paste0(ifelse(`Part. Œî %` > 0, "+", ""), round(`Part. Œî %`, 1), "%"),
      color = color_grad(tabla_puestos$`Part. Œî %`),
      bold = TRUE
    )
  ) %>% 
  kbl(
    align = c("l", "l", rep("r", 7)),
    escape = FALSE
  ) %>% 
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    position = "left",
    font_size = 13
  ) %>% 
  column_spec(1, bold = TRUE, width = "10em") %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  scroll_box(width = "100%", height = "500px")

```

::: callout-note
**Nota metodol√≥gica**

Las bases de datos empleadas en este estudio contienen informaci√≥n completa de los puestos de votaci√≥n para cada elecci√≥n; sin embargo, los an√°lisis desarrollados a lo largo del informe se realizan exclusivamente sobre el subconjunto de puestos que coinciden en ambas elecciones (2018 y 2022), con el objetivo de asegurar la consistencia y comparabilidad temporal de los resultados. En contraste, el mapa de visualizaci√≥n presentado en la secci√≥n 2.5 incorpora la totalidad de los puestos de votaci√≥n habilitados en cada elecci√≥n, dado que su finalidad es estrictamente descriptiva y busca proporcionar una representaci√≥n espacial exhaustiva del territorio.
:::

------------------------------------------------------------------------

```{r footer, results='asis', echo=FALSE}
cat('
<div style="text-align: center; margin-top: 40px; padding: 20px; background-color: #ecf0f1; border-radius: 8px;">
<strong style="font-size: 16px;">Evoluci√≥n territorial del voto por Gustavo Petro en el Magdalena</strong><br>
<span style="font-size: 14px;">Elecciones presidenciales 2018‚Äì2022</span><br>
<em style="font-size: 12px; color: #7f8c8d;">
Centro de Investigaci√≥n en Econom√≠a y Finanzas (CIENFI) ‚Äì Universidad Icesi
</em>
</div>
')
```
