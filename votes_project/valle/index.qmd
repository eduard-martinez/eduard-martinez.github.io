---
title: "Evoluci√≥n territorial del voto por Gustavo Petro en el Valle del Cauca"
subtitle: "Elecciones presidenciales 2018‚Äì2022"
author: 
  - "Centro de Investigaci√≥n en Econom√≠a y Finanzas (CIENFI)"
  - "Universidad Icesi"
lang: es
format: 
  html:
    self-contained: true
    number-sections: true
    code-fold: false
    code-tools: false
    toc: true
    toc-depth: 3
    toc-location: left
    theme: cosmo
    fontsize: 18px
    page-layout: full
    df-print: paged
    smooth-scroll: true
    embed-resources: true
execute:
  echo: false
  warning: false
  message: false
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 10)
```

```{r librerias}
# Cargar librer√≠as
library(tidyverse)
library(rio)
library(sf)
library(leaflet)
library(crosstalk)
library(DT)
library(scales)
library(htmltools)
library(plotly)
library(kableExtra)
library(patchwork)
library(ggrepel)
library(dplyr)
```

```{r cargar_datos_procesados}
# ============================================================================
# CARGAR TODOS LOS OUTPUTS DE LOS PASOS ANTERIORES
# ============================================================================

# Datos preparados
#datos_comparacion <- readRDS(
#  file.path("..", "02_prepare", "output", "datos_comparacion.rds")
#)

# Ruta relativa segura
datos_comparacion <- readRDS("../02_prepare/output/datos_comparacion.rds")

datos_mapa <- readRDS(
  file.path("..", "02_prepare", "output", "datos_mapa.rds")
)

```

::: {.callout-tip appearance="minimal" title="Resumen"}
Este informe presenta un an√°lisis comparativo de los resultados electorales en el departamento del Valle del Cauca para las elecciones presidenciales de **2018** y **2022**, con √©nfasis en la **evoluci√≥n territorial del voto de Gustavo Petro** entre ambos ciclos electorales.

El analis muestra c√≥mo cambiaron los patrones de apoyo en **primera** y **segunda vuelta**, y contrasta estas din√°micas con los candidatos que disputaron la segunda vuelta en cada elecci√≥n: Iv√°n Duque (2018) y Rodolfo Hern√°ndez (2022).

A partir de informaci√≥n desagregada por puesto de votaci√≥n, se identifican variaciones espaciales en la intensidad del voto, cambios en la participaci√≥n y reconfiguraciones del mapa electoral departamental, con el fin de aportar evidencia clara y √∫til para el an√°lisis pol√≠tico y territorial.
:::

# An√°lisis Municipal

El Valle del Cauca se divide en **42 municipios**, con Cali como su principal centro urbano, concentrando gran parte de la poblaci√≥n y del electorado. Entre 2018 y 2022, el apoyo a Gustavo Petro creci√≥ de manera notable, destacando municipios clave como Buenaventura (70.2% ‚Üí 84.9%), Cali (52.4% ‚Üí 63.1%) y Yumbo (63.6% ‚Üí 75.6%).

El mapa permite explorar la proporci√≥n de votos de Petro en el municipio y visualizar c√≥mo se intensific√≥ el respaldo. Para **2022** se observa una **consolidaci√≥n del voto en el centro y sur** del departamento ‚ÄîBuenaventura, Yumbo, Candelaria, El Cerrito, entre otros superan el 70%‚Äî mientras que en el norte, municipios como El Aguila, El Cairo, Versalles y Argelia muestran incrementos m√°s moderados, con apoyo a√∫n por debajo del 30%. Este patr√≥n evidencia un voto territorialmente desigual, con zonas estrat√©gicas de mayor intensidad electoral.

::: panel-tabset
## Segunda vuelta

```{r}
# Cargar mapas de Magdalena
magdalena_map_1 <- readRDS("../03_figures/output/valle_map_2018.rds")
magdalena_map_2 <- readRDS("../03_figures/output/valle_map_2022.rds")

# Definir colores rojos
colores_rojos <- c(
  "0-20%"  = "#fff5f0",
  "20-30%" = "#fee0d2",
  "30-40%" = "#fcbba1",
  "40-50%" = "#fc9272",
  ">50%"   = "#fb6a4a"
)

# Categorizar votos (si no lo has hecho)
categorizar_votos <- function(df) {
  df %>%
    mutate(prop_cat = case_when(
      prop_mpio < 0.2 ~ "0-20%",
      prop_mpio >= 0.2 & prop_mpio < 0.3 ~ "20-30%",
      prop_mpio >= 0.3 & prop_mpio < 0.4 ~ "30-40%",
      prop_mpio >= 0.4 & prop_mpio < 0.5 ~ "40-50%",
      prop_mpio >= 0.5 ~ ">50%"
    )) %>%
    mutate(prop_cat = factor(prop_cat,
                             levels = c("0-20%", "20-30%", "30-40%", "40-50%", ">50%")))
}

magdalena_map_1 <- categorizar_votos(magdalena_map_1)
magdalena_map_2 <- categorizar_votos(magdalena_map_2)

pal <- colorFactor(
  palette = colores_rojos,
  domain = magdalena_map_1$prop_cat
)

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    data = magdalena_map_1,
    fillColor = ~pal(prop_cat),
    color = "black",
    weight = 1,
    fillOpacity = 0.7,
    label = ~mpio_label,
    group = "2018",
    highlight = highlightOptions(
      weight = 3,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addPolygons(
    data = magdalena_map_2,
    fillColor = ~pal(prop_cat),
    color = "black",
    weight = 1,
    fillOpacity = 0.7,
    label = ~mpio_label,
    group = "2022",
    highlight = highlightOptions(
      weight = 3,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addLegend(
    "bottomright",
    colors = colores_rojos,
    labels = names(colores_rojos),
    title = "Proporci√≥n de votos"
  ) %>%
  addLayersControl(
    baseGroups = c("2018", "2022"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  hideGroup("2022")
```
:::

## Participaci√≥n Electoral

Entre 2018 y 2022, los vallecaucanos salieron a votar m√°s: la participaci√≥n creci√≥ un **13.4% en primera vuelta** (de 1.76 millones a 2.00 millones de votos) y un **21.1% en segunda vuelta¬®** (de 1.73 millones a 2.09 millones). En este periodo, **el apoyo a Gustavo Petro registr√≥ un crecimiento a√∫n m√°s notable**. En primera vuelta, pas√≥ de captar *poco m√°s de una cuarta parte de los votos* (27.33%) a **m√°s de la mitad** (52.47%). **En segunda vuelta, el avance fue igualmente contundente:** pas√≥ del 50.93% al 62.96%. As√≠, en apenas cuatro a√±os, Petro pas√≥ de ser un candidato que *compet√≠a activamente en la contienda* a consolidarse como la *opci√≥n dominante en el departamento*.

```{r resumen_general}
# Calcular totales del departamento
total_votos_v1_2018 <- sum(datos_comparacion$t_votos_v1_2018, na.rm = TRUE)
total_votos_v2_2018 <- sum(datos_comparacion$t_votos_v2_2018, na.rm = TRUE)
total_votos_v1_2022 <- sum(datos_comparacion$t_votos_v1_2022, na.rm = TRUE)
total_votos_v2_2022 <- sum(datos_comparacion$t_votos_v2_2022, na.rm = TRUE)

# Calcular votos de Petro
petro_v1_2018 <- sum(datos_comparacion$Petro_v1_2018, na.rm = TRUE)
petro_v2_2018 <- sum(datos_comparacion$Petro_v2_2018, na.rm = TRUE)
petro_v1_2022 <- sum(datos_comparacion$Petro_v1_2022, na.rm = TRUE)
petro_v2_2022 <- sum(datos_comparacion$Petro_v2_2022, na.rm = TRUE)

# Crear tabla de participaci√≥n electoral
resumen <- tibble(
  Indicador = c(
    "Total Votos 2018 - Primera Vuelta",
    "Total Votos 2018 - Segunda Vuelta",
    "Total Votos 2022 - Primera Vuelta",
    "Total Votos 2022 - Segunda Vuelta"
  ),
  Valor = c(
    total_votos_v1_2018,
    total_votos_v2_2018,
    total_votos_v1_2022,
    total_votos_v2_2022
  ),
  `Proporci√≥n Petro (%)` = c(
    (petro_v1_2018 / total_votos_v1_2018) * 100,
    (petro_v2_2018 / total_votos_v2_2018) * 100,
    (petro_v1_2022 / total_votos_v1_2022) * 100,
    (petro_v2_2022 / total_votos_v2_2022) * 100
  )
)

resumen %>% 
  mutate(
    Valor = comma(Valor),
    `Proporci√≥n Petro (%)` = paste0(round(`Proporci√≥n Petro (%)`, 2), "%")
  ) %>% 
  kbl(align = c("l", "r", "r")) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover"),
    full_width = FALSE,
    position = "left",
    font_size = 12
  ) %>% 
  column_spec(1, bold = TRUE, width = "18em") %>% 
  column_spec(2, width = "8em") %>% 
  column_spec(3, width = "10em", color = "white", background = "#3498db") %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50")
```

## Petro frente a sus contrincantes

Petro sum√≥ m√°s de **566 mil votos nuevos en primera vuelta (+118%)** y cerca de **438 mil en segunda vuelta (+50%)** entre ambas elecciones. Sus rivales, en cambio, perdieron fuerza. Duque obtuvo 520 mil votos en la primera vuelta de 2018; Hern√°ndez apenas lleg√≥ a 331 mil en 2022, una ca√≠da del 36%. En segunda vuelta la p√©rdida se mantuvo: Hern√°ndez recibi√≥ 41 mil votos menos que Duque cuatro a√±os atr√°s (-6%).

El contraste es claro: mientras Petro expandi√≥ su base electoral en ambas vueltas, la coalici√≥n opositora se contrajo significativamente en primera vuelta y no logr√≥ recuperarse en la definici√≥n. El Valle del Cauca no solo vot√≥ m√°s por Petro; vot√≥ decididamente menos por sus opositores.

```{r tabla_agregada_mejorada}
# Crear tabla resumen con m√©tricas adicionales
tabla_valle_larga <- tibble(
  Regi√≥n = rep("Valle del Cauca", 4),
  Candidato = c("Gustavo Petro", "Gustavo Petro", 
                "Contrincante (Duque 2018 / Hern√°ndez 2022)", 
                "Contrincante (Duque 2018 / Hern√°ndez 2022)"),
  Vuelta = rep(c("Primera Vuelta", "Segunda Vuelta"), 2),
  
  `2018` = c(
    sum(datos_comparacion$Petro_v1_2018, na.rm = TRUE),
    sum(datos_comparacion$Petro_v2_2018, na.rm = TRUE),
    sum(datos_comparacion$Duque_v1_2018, na.rm = TRUE),
    sum(datos_comparacion$Duque_v2_2018, na.rm = TRUE)
  ),
  
  `2022` = c(
    sum(datos_comparacion$Petro_v1_2022, na.rm = TRUE),
    sum(datos_comparacion$Petro_v2_2022, na.rm = TRUE),
    sum(datos_comparacion$Hernandez_v1_2022, na.rm = TRUE),
    sum(datos_comparacion$Hernandez_v2_2022, na.rm = TRUE)
  )
) %>%
  mutate(
    `Œî Absoluta` = `2022` - `2018`,
    `Œî %` = ((`2022` - `2018`) / `2018`) * 100
  )

# Mostrar tabla formateada
tabla_valle_larga %>%
  mutate(
    `2018` = comma(`2018`),
    `2022` = comma(`2022`),
    `Œî Absoluta` = paste0(ifelse(`Œî Absoluta` > 0, "+", ""), comma(`Œî Absoluta`)),
    `Œî %` = paste0(ifelse(`Œî %` > 0, "+", ""), round(`Œî %`, 2), "%")
  ) %>%
  knitr::kable(
    align = c("l", "l", "l", "r", "r", "r", "r")
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered")) %>%
  row_spec(1:2, background = "#d4edda") %>%  # Color suave para Petro
  row_spec(3:4, background = "#f8d7da")      # Color suave para contrincantes
```

## Resultados por municipio

Los 42 municipios del Valle del Cauca muestran trayectorias diversas, pero con un patr√≥n com√∫n: **en 2022 Petro gan√≥ votos en todos los municipios respecto a la elecci√≥n anterior**. Las diferencias est√°n en la magnitud. Versalles ‚Äîubicado en el norte del departamento‚Äî increment√≥ en casi 2.5 veces el apoyo al candidato en primera vuelta (+248%); Argelia, en cambio, creci√≥ un 89%. **Cali**, con su volumen electoral, **aport√≥ m√°s de 283 mil votos nuevos en primera vuelta**, representando m√°s de la mitad del crecimiento total de Petro en el departamento, aunque su crecimiento porcentual (+128%) fue modesto comparado con municipios m√°s peque√±os.

Lo interesante est√° en la columna de participaci√≥n: algunos municipios en los que creci√≥ el voto por Petro tambi√©n crecieron significativamente en participaci√≥n total (Jamund√≠ +46%, Buenaventura +30%), mientras otros mantuvieron o incluso redujeron sus niveles de votaci√≥n (Obando -17%, Versalles -11%), **pero redistribuyeron sus preferencias hacia √©l**. El patr√≥n es claro: el crecimiento de Petro -en especial en 2022- no dependi√≥ solo de nueva participaci√≥n, sino de una conversi√≥n real del electorado vallecaucano.

```{r tabla_municipios_detallada}
resumen_municipios <- datos_comparacion %>% 
  filter(ambos) %>% 
  group_by(mpio) %>% 
  summarise(
    `N¬∞ Puestos` = n(),
    
    # Petro Primera Vuelta
    `Petro 2018 V1` = sum(Petro_v1_2018, na.rm = TRUE),
    `Petro 2022 V1` = sum(Petro_v1_2022, na.rm = TRUE),
    `Œî Abs V1` = `Petro 2022 V1` - `Petro 2018 V1`,
    `Œî % V1` = ((`Petro 2022 V1` - `Petro 2018 V1`) / `Petro 2018 V1`) * 100,
    
    # Petro Segunda Vuelta
    `Petro 2018 V2` = sum(Petro_v2_2018, na.rm = TRUE),
    `Petro 2022 V2` = sum(Petro_v2_2022, na.rm = TRUE),
    `Œî Abs V2` = `Petro 2022 V2` - `Petro 2018 V2`,
    `Œî % V2` = ((`Petro 2022 V2` - `Petro 2018 V2`) / `Petro 2018 V2`) * 100,
    
    # Participaci√≥n
    `Part. Œî %` = mean(var_participacion_v2, na.rm = TRUE)
  ) %>% 
  arrange(desc(`Œî Abs V2`))

# Funci√≥n para aplicar color condicional
color_var <- function(x) {
  case_when(
    x > 0 ~ "#27ae60",   # Verde
    x < 0 ~ "#c0392b",   # Rojo
    TRUE ~ "#2c3e50"     # Gris oscuro
  )
}

resumen_municipios %>% 
  mutate(
    across(c(`Petro 2018 V1`, `Petro 2022 V1`, `Œî Abs V1`,
             `Petro 2018 V2`, `Petro 2022 V2`, `Œî Abs V2`), ~comma(.x)),
    `Œî % V1` = paste0(ifelse(`Œî % V1` > 0, "+", ""), round(`Œî % V1`, 1), "%"),
    `Œî % V2` = paste0(ifelse(`Œî % V2` > 0, "+", ""), round(`Œî % V2`, 1), "%"),
    `Part. Œî %` = paste0(ifelse(`Part. Œî %` > 0, "+", ""), round(`Part. Œî %`, 1), "%")
  ) %>% 
  kbl(align = c("l", rep("r", 10))) %>% 
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    position = "left",
    font_size = 13
  ) %>% 
  column_spec(1, bold = TRUE, width = "12em") %>% 
  column_spec(6, 
    color = spec_color(resumen_municipios$`Œî % V1`, 
                       begin = 0.3, end = 0.9, 
                       option = "D", direction = 1)
  ) %>% 
  column_spec(10, 
    color = spec_color(resumen_municipios$`Œî % V2`, 
                       begin = 0.3, end = 0.9, 
                       option = "D", direction = 1)
  ) %>% 
  column_spec(11, 
    color = spec_color(resumen_municipios$`Part. Œî %`, 
                       begin = 0.3, end = 0.9, 
                       option = "D", direction = 1)
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  scroll_box(width = "100%", height = "500px")
```

------------------------------------------------------------------------

# An√°lisis a Nivel Puesto de Votaci√≥n

Para 2022, el Valle del Cauca cont√≥ con **1082 puestos de votaci√≥n** habilitados por la Registradur√≠a, distribuidos en sus 42 municipios. **Cali concentra 190 de ellos**, alrededor de un 20% del total departamental, reflejando su peso demogr√°fico como capital. Le siguen  Palmira con 86, Buenaventura con 84 puestos, y Tulu√° con 56, configurando los cuatro principales centros electorales del departamento.

Esta distribuci√≥n marca diferencias importantes en c√≥mo se lee el voto. En municipios peque√±os, un solo puesto puede definir el resultado municipal completo. En Cali, en cambio, la diversidad de puestos permite identificar patrones espaciales m√°s finos, que empiezan a mostrar d√≥nde exactamente ocurrieron los cambios en los resultados electorales y qu√© caracter√≠sticas territoriales podr√≠an estar asociadas.

## Correlaci√≥n de Votos 2018 vs 2022

Este gr√°fico compara puesto por puesto el desempe√±o de Petro en segunda vuelta entre ambas elecciones. Cada punto representa un puesto de votaci√≥n: en el eje horizontal est√° su votaci√≥n en 2018, en el vertical la de 2022. La l√≠nea punteada marca el equilibrio: si un puesto cayera exactamente sobre ella, significar√≠a que Petro obtuvo los mismos votos en ambos a√±os.

Salta a la vista que **la mayor√≠a de puntos se ubican por encima de esa l√≠nea**. Petro creci√≥ en una gran parte todos los puestos del departamento. Los puntos en *verde m√°s intenso* marcan los crecimientos m√°s pronunciados: puestos donde duplic√≥ o incluso triplic√≥ su votaci√≥n. Los pocos puntos rosados, ubicados bajo la l√≠nea, se√±alan las excepciones: lugares donde *perdi√≥ votos* entre una elecci√≥n y otra en segunda vuelta.

La nube de puntos tambi√©n muestra una correlaci√≥n positiva: los puestos donde Petro ya era fuerte en 2018 tendieron a crecer a√∫n m√°s en 2022, consolidando bastiones. Pero incluso en territorios donde part√≠a de votaciones bajas logr√≥ sumar.

```{r correlacion_petro_interactivo, echo=FALSE}
library(plotly)

p <- datos_comparacion %>% 
  filter(ambos) %>% 
  ggplot(
    aes(
      x = Petro_v2_2018,
      y = Petro_v2_2022,
      text = paste0(
        "<b>Puesto:</b> ", puesto_nom, "<br>",
        "<b>Municipio:</b> ", mpio, "<br>",
        "<b>Votos 2018:</b> ", comma(Petro_v2_2018), "<br>",
        "<b>Votos 2022:</b> ", comma(Petro_v2_2022), "<br>",
        "<b>Variaci√≥n (%):</b> ", round(var_Petro_v2, 1)
      )
    )
  ) +
  geom_point(
    aes(color = var_Petro_v2, size = t_votos_v2_2022),
    alpha = 0.85,
    stroke = 0.4
  ) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black") +
  scale_color_gradient2(
    low = "#8B0000",      # rojo fuerte
    mid = "#FFFFFF",      # blanco puro
    high = "#003300",     # verde oscuro
    midpoint = 0
  ) +
  scale_size_continuous(range = c(4, 10)) +
  labs(
    x = "Votos Petro 2018 (2da vuelta)",
    y = "Votos Petro 2022 (2da vuelta)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank()
  )

ggplotly(p, tooltip = "text")

```

## Mayores Ganancias de Petro

Estos diez puestos registraron las mayores variaciones absolutas en el voto por Petro al comparar las rondas finales de 2018 y 2022. El *colegio Gimnasio Moderno del Valle en Jamund√≠* lidera con un incremento porcentual extraordinario: pas√≥ de 749 votos a 3.832, sumando 3.083 votos nuevos (+411.6%). Le siguen *Univalle Sede Mel√©ndez* con 5.271 votos adicionales y el *Colegio Fundaci√≥n Compartir* con un aumento de 4.223 votos.

La geograf√≠a de estas ganancias muestra un patr√≥n interesante: nueve de los diez puestos est√°n en Cali, concentrados en colegios de barrios populares y zonas de expansi√≥n urbana como Calimio, Olaya Herrera y La Anunciaci√≥n. El √∫nico puesto fuera de Cali corresponde a Jamund√≠, municipio conurbado del √°rea metropolitana. Son territorios con alta densidad de votantes, donde peque√±os movimientos en preferencias se traducen en miles de votos.

```{r top_ganancias}
datos_comparacion %>% 
  filter(ambos, !is.na(var_abs_Petro_v2)) %>% 
  arrange(desc(var_abs_Petro_v2)) %>% 
  head(10) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `2018` = Petro_v2_2018,
    `2022` = Petro_v2_2022,
    `Ganancia` = var_abs_Petro_v2,
    `Var %` = var_Petro_v2
  ) %>% 
  mutate(
    across(c(`2018`, `2022`, Ganancia), ~comma(.x)),
    `Var %` = paste0("+", round(`Var %`, 1), "%")
  ) %>% 
  kbl(align = c("l", "l", rep("r", 4))) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover"),
    full_width = FALSE,
    font_size = 12
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#27ae60") %>% 
  column_spec(1:2, bold = TRUE, width = "10em") %>% 
  column_spec(3:6, width = "7em")
```

## Mayores P√©rdidas de Petro

No todo fue crecimiento. Estos diez puestos registraron las mayores p√©rdidas absolutas en el voto por Petro entre las rondas finales de 2018 y 2022. El *Colegio Comfandi* en Cali lidera las ca√≠das con 1.443 votos menos (-18.8%), seguido por el Club *El Para√≠so en El Cerrito* con una p√©rdida de 1.128 votos (-48.4%), y la Escuela Miguel Camacho Perea en Cali con 1.100 votos menos (-30.2%).

La distribuci√≥n espacial de estas p√©rdidas revela un patr√≥n distintivo. Siete de los diez puestos se localizan en Cali, concentrados principalmente en sectores del sur de la ciudad caracterizados por estratos medios y altos. Casos como el Colegio Bennett, ubicado en Ciudad Jard√≠n, y Pance, en el corredor tur√≠stico del sur, ilustran territorios tradicionalmente asociados a poblaci√≥n de clase media-alta donde el apoyo a Petro se redujo. Los dem√°s puestos corresponden a El Cerrito, Buenaventura y Jamund√≠, municipios que colindan con Cali. Cabe resaltar que, a pesar de estas ca√≠das relativas, varios de estos puestos mantienen niveles elevados de votaci√≥n absoluta por Petro, como el SENA con 5.699 votos, Comfandi con 6.228 y la CVC con 3.631, lo que sugiere que las p√©rdidas se producen sobre bases electorales previamente amplias.


```{r top_perdidas}
datos_comparacion %>% 
  filter(ambos, !is.na(var_abs_Petro_v2)) %>% 
  arrange(var_abs_Petro_v2) %>% 
  head(10) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `2018` = Petro_v2_2018,
    `2022` = Petro_v2_2022,
    `P√©rdida` = var_abs_Petro_v2,
    `Var %` = var_Petro_v2
  ) %>% 
  mutate(
    across(c(`2018`, `2022`, P√©rdida), ~comma(.x)),
    `Var %` = paste0(round(`Var %`, 1), "%")
  ) %>% 
  kbl(align = c("l", "l", rep("r", 4))) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover"),
    full_width = FALSE,
    font_size = 12
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#c0392b") %>% 
  column_spec(1:2, bold = TRUE, width = "10em") %>% 
  column_spec(3:6, width = "7em")
```

## Puestos que Cambiaron de Ganador entre elecciones (Flips)

La tabla muestra los puestos que cambiaron de ganador entre 2018 y 2022, tanto en primera como en segunda vuelta. Buenaventura es un caso interesante: varios de sus puestos donde hab√≠a ganado Duque o Vargas Lleras en 2018 viraron a Petro en 2022, consolidando el dominio petrista en el puerto. En Cali, decenas de colegios que fueron de Fajardo o Duque en primera vuelta de 2018 pasaron a manos de Petro cuatro a√±os despu√©s.

El patr√≥n se repite en Buga, Bugalagrande y Bol√≠var, donde colegios y corregimientos que votaron mayoritariamente por Duque en 2018 eligieron a Petro cuatro a√±os despu√©s. Algunos cambios son particularmente llamativos: en Andaluc√≠a y Buga, puestos que hab√≠an votado por Vargas Lleras en primera vuelta de 2018 pasaron directamente a Petro en 2022.

Pero no todo el mapa vir√≥ hacia Petro. En municipios como Ansermanuevo, Argelia, Caicedonia y Alcal√°, varios puestos que gan√≥ Duque en 2018 no fueron para Petro sino para Rodolfo Hern√°ndez en 2022 (tanto en primera como en segunda vuelta). Federico Guti√©rrez logr√≥ sostener algunos territorios que Duque hab√≠a ganado ‚Äîcomo en zonas espec√≠ficas de Cali (CAM, Club de Leones La Merced, Colegio Benett, Los Andes, Odontol√≥gico, Reyes Cat√≥licos, entre otros)‚Äî, aunque en general la coalici√≥n uribista no consigui√≥ retener el apoyo de 2018 en el departamento.


```{r analisis_flips}
# Tabla de flips - CONSIDERANDO TODOS LOS CANDIDATOS
flips_completa <- datos_comparacion %>% 
  filter(ambos) %>% 
  mutate(
    # Determinar si Petro gan√≥ en todas las vueltas de ambas elecciones
    petro_gano_todas = (ganador_v1_2018 == "Petro" & ganador_v2_2018 == "Petro" &
                        ganador_v1_2022 == "Petro" & ganador_v2_2022 == "Petro"),
    # Determinar si Petro no gan√≥ en ninguna
    petro_perdio_todas = (ganador_v1_2018 != "Petro" & ganador_v2_2018 != "Petro" &
                          ganador_v1_2022 != "Petro" & ganador_v2_2022 != "Petro")
  ) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `2018 V1` = ganador_v1_2018,
    `2018 V2` = ganador_v2_2018,
    `2022 V1` = ganador_v1_2022,
    `2022 V2` = ganador_v2_2022,
    petro_gano_todas,
    petro_perdio_todas
  ) %>% 
  arrange(Municipio, Puesto)

# Crear √≠ndices para colorear filas
idx_petro_todas <- which(flips_completa$petro_gano_todas)
idx_petro_ninguna <- which(flips_completa$petro_perdio_todas)

# Tabla principal
flips_completa %>% 
  select(-petro_gano_todas, -petro_perdio_todas) %>% 
  kbl(align = c("l", "l", rep("c", 4))) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover", "striped"),
    full_width = FALSE,
    font_size = 11
  ) %>% 
  column_spec(1, bold = TRUE, width = "10em") %>% 
  column_spec(2, width = "15em") %>% 
  column_spec(3:6, width = "7em") %>% 
  add_header_above(c(" " = 2, "Ganador 2018" = 2, "Ganador 2022" = 2)) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  row_spec(idx_petro_todas, background = "#c8e6c9", bold = TRUE) %>% 
  row_spec(idx_petro_ninguna, background = "#ffcdd2") %>% 
  scroll_box(width = "100%", height = "600px")
```

## Mirada espacial de los votos

Este mapa interactivo geolocaliza los puestos de votaci√≥n del Valle del Cauca y muestra visualmente c√≥mo cambi√≥ el voto por Petro en **segunda vuelta** entre ambas elecciones. Cada c√≠rculo representa un puesto: su tama√±o es proporcional a la participaci√≥n electoral en 2022 (mientras mayor el n√∫mero de votantes, m√°s grande el punto), y su color indica la magnitud del cambio.

El verde domina el mapa. Los puntos en *üü¢ verde oscuro (50% o m√°s)* corresponden a los puestos donde Petro duplic√≥ o triplic√≥ su votaci√≥n. El *üü¢ verde claro (25% a 50%)* se√±ala crecimientos moderados pero significativos. El *üü° amarillo (-25% a 25%)* indica estabilidad relativa. Los pocos puntos en *üü† naranja (-50% a -25%)* y *üî¥ rojo oscuro (-50% o m√°s)*, concentrados principalmente en la capital, muestran los crecimientos m√°s modestos y/o p√©rdidas. Los puntos en *‚ö´ gris* corresponden a puestos sin informaci√≥n comparable.

Desde una perspectiva espacial, el comportamiento del voto por Gustavo Petro no fue homog√©neo entre territorios. Una fracci√≥n importante de los puestos presentan variaciones positivas (tonos verdes), lo que indica un incremento en su proporci√≥n de votos en segunda vuelta, especialmente a lo largo del eje central del departamento, que conecta municipios como Cali, Palmira, Tulu√° y Buga. En contraste, al norte del departamento ‚Äîmunicipios como Ansermanuevo, Argelia, El √Åguila y El Cairo‚Äî ocurren los menores crecimientos en t√©rminos de participaci√≥n entre vueltas, sugiriendo din√°micas electorales distintas a las del corredor central y sur del Valle.

En t√©rminos de participaci√≥n electoral, el tama√±o de los puntos permite identificar una fuerte concentraci√≥n del electorado en los principales centros urbanos e intermedios del departamento.En particular, en municipios como Buenaventura, el crecimiento del apoyo se observa predominantemente en los puestos de mayor peso electoral, lo que indica que la expansi√≥n del voto tuvo un impacto sustantivo en el resultado agregado. en puestos ubicados en zonas rurales y corregimientos, a pesar de su baja participaci√≥n electoral, Petro logr√≥ fuertes victorias. Este patr√≥n evidencia que la expansi√≥n del petrismo no se limit√≥ a los grandes centros urbanos, sino que penetr√≥ territorios hist√≥ricamente marginales del departamento.


```{r mapa_interactivo, fig.height=10}
# Calcular tama√±os de radio proporcionales a participaci√≥n
datos_mapa <- datos_mapa %>% 
  mutate(
    # Usar votos de segunda vuelta 2022 (o 2018 si no hay 2022)
    votos_referencia = coalesce(t_votos_v2_2022, t_votos_v2_2018, 0),
    # Escalar radius entre 4 y 18 basado en participaci√≥n (ra√≠z cuadrada para mejor visualizaci√≥n)
    radius_scaled = scales::rescale(sqrt(votos_referencia), to = c(4, 18))
  )

# Preparar datos para crosstalk
datos_compartidos <- SharedData$new(
  datos_mapa %>% 
    mutate(
      mpio = ifelse(is.na(mpio), "Sin municipio", mpio),
      puesto_nom = ifelse(is.na(puesto_nom), "Sin nombre", puesto_nom)
    ),
  key = ~id_puesto
)

# Paleta de colores con rangos
pal <- colorBin(
  palette = c("#d73027", "#fc8d59", "#fee08b", "#d9ef8b", "#91cf60", "#1a9850"),
  domain = datos_mapa$var_Petro_v2,
  bins = c(-Inf,-50, -25, 25, 50, 100, Inf),
  na.color = "#808080"
)

# Filtro por municipio
filter_select(
  id = "municipio",
  label = "Selecciona municipio:",
  sharedData = datos_compartidos,
  group = ~mpio,
  multiple = TRUE
)

# Crear el mapa con fondo claro, m√°s grande y puntos proporcionales
leaflet(datos_compartidos, height = 750, width = "100%") %>% 
  # Usar CartoDB Positron para fondo minimalista y claro
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    lng = ~lon,
    lat = ~lat,
    radius = ~radius_scaled,  # Radio variable seg√∫n participaci√≥n
    color = "#2c3e50",  # Borde oscuro para mejor contraste
    fillColor = ~pal(var_Petro_v2),
    fillOpacity = 0.7,
    stroke = TRUE,
    weight = 1.5,
    opacity = 0.9,
    popup = ~paste0(
      "<div style='width:520px; background-color:#ffffff; padding:15px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15);'>",
      "<h4 style='margin:0 0 10px 0; color:#2c3e50; border-bottom:2px solid #3498db; padding-bottom:8px;'><strong>", puesto_nom, "</strong></h4>",
      "<p style='margin:5px 0; font-size:13px;'><strong>Municipio:</strong> ", mpio, "</p>",
      "<p style='margin:5px 0; font-size:13px;'><strong>ID:</strong> ", id_puesto, "</p>",
      
      ifelse(solo_2018, 
        "<div style='margin:10px 0; padding:10px; background-color:#fff3cd; border-left:4px solid #ffc107; border-radius:4px;'><strong>‚ö†Ô∏è Solo datos 2018</strong></div>",
        ifelse(solo_2022,
          "<div style='margin:10px 0; padding:10px; background-color:#d1ecf1; border-left:4px solid #17a2b8; border-radius:4px;'><strong>‚ÑπÔ∏è Solo datos 2022</strong></div>",
          "")),
      
      "<hr style='margin:15px 0; border:none; border-top:1px solid #ddd;'>",
      
      "<table style='width:100%; border-collapse: collapse; font-size:12px; background-color:#ffffff;'>",
      "<thead>",
      "<tr style='background-color:#34495e; color:white;'>",
      "<th colspan='4' style='padding:10px; text-align:center; border:1px solid #bdc3c7; font-size:13px;'>GUSTAVO PETRO</th>",
      "</tr>",
      "<tr style='background-color:#ecf0f1;'>",
      "<th style='padding:6px; border:1px solid #bdc3c7; font-weight:bold;'></th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>2018</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>2022</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Œî</th>",
      "</tr>",
      "</thead>",
      "<tbody style='background-color:#ffffff;'>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>1¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v1_2018), comma(Petro_v1_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v1_2022), comma(Petro_v1_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Petro_v1) & var_Petro_v1 > 0, "#27ae60", 
               ifelse(!is.na(var_Petro_v1) & var_Petro_v1 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Petro_v1), paste0(ifelse(var_Petro_v1 > 0, "+", ""), round(var_Petro_v1, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>2¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v2_2018), comma(Petro_v2_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v2_2022), comma(Petro_v2_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Petro_v2) & var_Petro_v2 > 0, "#27ae60", 
               ifelse(!is.na(var_Petro_v2) & var_Petro_v2 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Petro_v2), paste0(ifelse(var_Petro_v2 > 0, "+", ""), round(var_Petro_v2, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "</tbody>",
      "</table>",
      
      "<div style='height:12px;'></div>",
      
      "<table style='width:100%; border-collapse: collapse; font-size:12px; background-color:#ffffff;'>",
      "<thead>",
      "<tr style='background-color:#c0392b; color:white;'>",
      "<th colspan='4' style='padding:10px; text-align:center; border:1px solid #bdc3c7; font-size:13px;'>CONTRINCANTES</th>",
      "</tr>",
      "<tr style='background-color:#ecf0f1;'>",
      "<th style='padding:6px; border:1px solid #bdc3c7; font-weight:bold;'></th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Duque 2018</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Hern√°ndez 2022</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Œî</th>",
      "</tr>",
      "</thead>",
      "<tbody style='background-color:#ffffff;'>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>1¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Duque_v1_2018), comma(Duque_v1_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Hernandez_v1_2022), comma(Hernandez_v1_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Contrincante_v1) & var_Contrincante_v1 > 0, "#27ae60", 
               ifelse(!is.na(var_Contrincante_v1) & var_Contrincante_v1 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Contrincante_v1), paste0(ifelse(var_Contrincante_v1 > 0, "+", ""), round(var_Contrincante_v1, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>2¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Duque_v2_2018), comma(Duque_v2_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Hernandez_v2_2022), comma(Hernandez_v2_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Contrincante_v2) & var_Contrincante_v2 > 0, "#27ae60", 
               ifelse(!is.na(var_Contrincante_v2) & var_Contrincante_v2 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Contrincante_v2), paste0(ifelse(var_Contrincante_v2 > 0, "+", ""), round(var_Contrincante_v2, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "</tbody>",
      "</table>",
      
      "<hr style='margin:15px 0; border:none; border-top:1px solid #ddd;'>",
      "<p style='font-size:11px; color:#7f8c8d; margin:0; padding:8px; background-color:#f8f9fa; border-radius:4px;'><strong>Participaci√≥n Œî:</strong> ",
      ifelse(!is.na(var_participacion_v2), 
        paste0(ifelse(var_participacion_v2 > 0, "+", ""), round(var_participacion_v2, 1), "% (2¬™ vuelta)"), 
        "N/A"),
      "</p>",
      
      "</div>"
    ),
    label = ~puesto_nom
  ) %>% 
  addLegend(
  position = "bottomright",
  pal = pal,
  values = ~var_Petro_v2,
  title = "Variaci√≥n Petro<br>2¬™ Vuelta (%)",
  opacity = 0.8,
  labFormat = function(type, cuts, p) {
    cuts <- as.numeric(cuts)

    paste0(
      ifelse(is.infinite(cuts[-length(cuts)]),
             ifelse(cuts[-length(cuts)] < 0, "< ", ""),
             cuts[-length(cuts)]),
      " ‚Äì ",
      ifelse(is.infinite(cuts[-1]),
             ifelse(cuts[-1] > 0, "> ", ""),
             cuts[-1]),
      "%"
    )
  },
  na.label = "Sin datos"
)


```


## Resultados por puestos de votaci√≥n

```{r tabla_datos_completa, results='asis'}

tabla_puestos <- datos_mapa %>% 
  st_drop_geometry() %>% 
  filter(ambos) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `Petro 2018 V1` = Petro_v1_2018,
    `Petro 2022 V1` = Petro_v1_2022,
    `Œî % V1` = var_Petro_v1,
    `Petro 2018 V2` = Petro_v2_2018,
    `Petro 2022 V2` = Petro_v2_2022,
    `Œî % V2` = var_Petro_v2,
    `Part. Œî %` = var_participacion_v2
  )

valores_color <- tabla_puestos %>% 
  select(`Œî % V1`, `Œî % V2`, `Part. Œî %`) %>% 
  unlist()

# Recorte robusto (percentil 95)
max_abs <- quantile(abs(valores_color), 0.95, na.rm = TRUE)

color_grad <- function(x) {

  # ---- correcci√≥n m√≠nima: evitar NA / Inf ----
  x[!is.finite(x)] <- 0

  intensidad <- abs(x) / max_abs
  intensidad <- pmin(intensidad, 1)
  intensidad <- 0.35 + 0.65 * intensidad
  
  ifelse(
    x > 0,
    col_numeric(c("#66bb6a", "#006400"), domain = c(0.35,1))(intensidad),
    col_numeric(c("#ef5350", "#8B0000"), domain = c(0.35,1))(intensidad)
  )
}

tabla_puestos %>% 
  mutate(
    across(contains("2018") | contains("2022"), ~comma(.x)),
    `Œî % V1` = cell_spec(
      paste0(ifelse(`Œî % V1` > 0, "+", ""), round(`Œî % V1`, 1), "%"),
      color = color_grad(tabla_puestos$`Œî % V1`),
      bold = TRUE
    ),
    `Œî % V2` = cell_spec(
      paste0(ifelse(`Œî % V2` > 0, "+", ""), round(`Œî % V2`, 1), "%"),
      color = color_grad(tabla_puestos$`Œî % V2`),
      bold = TRUE
    ),
    `Part. Œî %` = cell_spec(
      paste0(ifelse(`Part. Œî %` > 0, "+", ""), round(`Part. Œî %`, 1), "%"),
      color = color_grad(tabla_puestos$`Part. Œî %`),
      bold = TRUE
    )
  ) %>% 
  kbl(
    align = c("l", "l", rep("r", 7)),
    escape = FALSE
  ) %>% 
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    position = "left",
    font_size = 13
  ) %>% 
  column_spec(1, bold = TRUE, width = "10em") %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  scroll_box(width = "100%", height = "500px")


```


::: {.callout-note}
**Nota metodol√≥gica**

Las bases de datos empleadas en este estudio contienen informaci√≥n completa de los puestos de votaci√≥n para cada elecci√≥n; sin embargo, los an√°lisis desarrollados a lo largo del informe se realizan exclusivamente sobre el subconjunto de puestos que coinciden en ambas elecciones (2018 y 2022), con el objetivo de asegurar la consistencia y comparabilidad temporal de los resultados. En contraste, el mapa de visualizaci√≥n presentado en la secci√≥n 2.5 incorpora la totalidad de los puestos de votaci√≥n habilitados en cada elecci√≥n, dado que su finalidad es estrictamente descriptiva y busca proporcionar una representaci√≥n espacial exhaustiva del territorio.
:::
------------------------------------------------------------------------

```{r footer, results='asis', echo=FALSE}
cat('
<div style="text-align: center; margin-top: 40px; padding: 20px; background-color: #ecf0f1; border-radius: 8px;">
<strong style="font-size: 16px;">Evoluci√≥n territorial del voto por Gustavo Petro en el Valle del Cauca </strong><br>
<span style="font-size: 14px;">Elecciones presidenciales 2018‚Äì2022</span><br>
<em style="font-size: 12px; color: #7f8c8d;">
Centro de Investigaci√≥n en Econom√≠a y Finanzas (CIENFI) ‚Äì Universidad Icesi
</em>
</div>
')
```
