---
title: "Evoluci√≥n territorial del voto por Gustavo Petro en Cundinamarca y Bogota DC"
subtitle: "Elecciones presidenciales 2018‚Äì2022"
author: 
  - "Centro de Investigaci√≥n en Econom√≠a y Finanzas (CIENFI)"
  - "Universidad Icesi"
lang: es
format: 
  html:
    self-contained: true
    number-sections: true
    code-fold: false
    code-tools: false
    toc: true
    toc-depth: 3
    toc-location: left
    theme: cosmo
    fontsize: 18px
    page-layout: full
    df-print: paged
    smooth-scroll: true
    embed-resources: true
execute:
  echo: false
  warning: false
  message: false
editor: visual
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 10)
```

```{r librerias}
# Cargar librer√≠as
library(tidyverse)
library(rio)
library(sf)
library(leaflet)
library(crosstalk)
library(DT)
library(scales)
library(htmltools)
library(plotly)
library(kableExtra)
library(patchwork)
library(ggrepel)
library(dplyr)
```

```{r cargar_datos_procesados}
# ============================================================================
# CARGAR TODOS LOS OUTPUTS DE LOS PASOS ANTERIORES
# ============================================================================

# Datos preparados
#datos_comparacion <- readRDS(
#  file.path("..", "02_prepare", "output", "datos_comparacion.rds")
#)

# Ruta relativa segura
datos_comparacion <- readRDS("../02_prepare/output/datos_comparacion.rds")

datos_mapa <- readRDS(
  file.path("..", "02_prepare", "output", "datos_mapa.rds")
)

```

::: {.callout-tip appearance="minimal" title="Resumen"}
Este informe presenta un an√°lisis comparativo de los resultados electorales en el departamento de Cundinmarca para las elecciones presidenciales de **2018** y **2022**, con √©nfasis en la **evoluci√≥n territorial del voto de Gustavo Petro** entre ambos ciclos electorales.

El analis muestra c√≥mo cambiaron los patrones de apoyo en **primera** y **segunda vuelta**, y contrasta estas din√°micas con los candidatos que disputaron la segunda vuelta en cada elecci√≥n: Iv√°n Duque (2018) y Rodolfo Hern√°ndez (2022).

A partir de informaci√≥n desagregada por puesto de votaci√≥n, se identifican variaciones espaciales en la intensidad del voto, cambios en la participaci√≥n y reconfiguraciones del mapa electoral departamental, con el fin de aportar evidencia clara y √∫til para el an√°lisis pol√≠tico y territorial.
:::

# An√°lisis Municipal

Cundinamarca se divide en **116 municipios y un Distrito Capital** que concentra gran parte de la poblaci√≥n y del electorado. Entre 2018 y 2022, el apoyo a Gustavo Petro **creci√≥ de manera moderada**, destacando a Bogota (52.8% ‚Üí 58% ) y municipios clave como Soacha (56.2% ‚Üí 66.7%), Mosquera (47.8% ‚Üí 54.4%) y Facatativa (42.6% ‚Üí 53.2%).

El mapa permite explorar los resultados por municipio y visualizar c√≥mo se intensific√≥ el respaldo. Se observa que municipios donde Petro tenia un electorado consolidado se mantuvieron para las siguientes elecciones con peque√±as variaciones.

::: panel-tabset
## Segunda vuelta

```{r}
# Cargar mapas de Atlantico
magdalena_map_1 <- readRDS("../03_figures/output/cundi_map_2018.rds")
magdalena_map_2 <- readRDS("../03_figures/output/cundi_map_2022.rds")

# Definir colores rojos
colores_rojos <- c(
  "0-20%"  = "#fff5f0",
  "20-30%" = "#fee0d2",
  "30-40%" = "#fcbba1",
  "40-50%" = "#fc9272",
  ">50%"   = "#fb6a4a"
)

# Categorizar votos (si no lo has hecho)
categorizar_votos <- function(df) {
  df %>%
    mutate(prop_cat = case_when(
      prop_mpio < 0.2 ~ "0-20%",
      prop_mpio >= 0.2 & prop_mpio < 0.3 ~ "20-30%",
      prop_mpio >= 0.3 & prop_mpio < 0.4 ~ "30-40%",
      prop_mpio >= 0.4 & prop_mpio < 0.5 ~ "40-50%",
      prop_mpio >= 0.5 ~ ">50%"
    )) %>%
    mutate(prop_cat = factor(prop_cat,
                             levels = c("0-20%", "20-30%", "30-40%", "40-50%", ">50%")))
}

magdalena_map_1 <- categorizar_votos(magdalena_map_1)
magdalena_map_2 <- categorizar_votos(magdalena_map_2)

pal <- colorFactor(
  palette = colores_rojos,
  domain = magdalena_map_1$prop_cat
)

leaflet() %>%
  addProviderTiles("CartoDB.Positron") %>%
  addPolygons(
    data = magdalena_map_1,
    fillColor = ~pal(prop_cat),
    color = "black",
    weight = 1,
    fillOpacity = 0.7,
    label = ~mpio_label,
    group = "2018",
    highlight = highlightOptions(
      weight = 3,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addPolygons(
    data = magdalena_map_2,
    fillColor = ~pal(prop_cat),
    color = "black",
    weight = 1,
    fillOpacity = 0.7,
    label = ~mpio_label,
    group = "2022",
    highlight = highlightOptions(
      weight = 3,
      color = "#666",
      fillOpacity = 0.9,
      bringToFront = TRUE
    )
  ) %>%
  addLegend(
    "bottomright",
    colors = colores_rojos,
    labels = names(colores_rojos),
    title = "Proporci√≥n de votos"
  ) %>%
  addLayersControl(
    baseGroups = c("2018", "2022"),
    options = layersControlOptions(collapsed = FALSE)
  ) %>%
  hideGroup("2022")
```
:::

## Participaci√≥n Electoral

En 2018 la participaci√≥n cay√≥ entre primera y segunda vuelta (de **4.58 millones a 4.44 millones de votos**), en 2022 ocurri√≥ lo contrario, aumentando de **5.21 millones a 5.34 millones de votante**s, aunque el incremento no fue tan pronunciado. Lo m√°s revelador est√° en la evoluci√≥n del apoyo a Petro: en primera vuelta su proporci√≥n se dispar√≥ de **27.44%** en 2018 a **43.09%** en 2022, ganando casi **16** puntos porcentuales; en segunda vuelta el crecimiento fue m√°s moderado, pero igualmente determinante, pas√≥ de **49.33%** a **54.01%,** superando por primera vez la mayor√≠a absoluta en esta regi√≥n.

Esto muestra que Petro no solo aument√≥ su caudal de votos, sino que mejor√≥ considerablemente su alcance electoral, convirtiendo a m√°s de la mitad del electorado activo de la capital y Cundinamarca en sus votantes durante la ronda decisiva de 2022.

```{r resumen_general}
# Calcular totales del departamento
total_votos_v1_2018 <- sum(datos_comparacion$t_votos_v1_2018, na.rm = TRUE)
total_votos_v2_2018 <- sum(datos_comparacion$t_votos_v2_2018, na.rm = TRUE)
total_votos_v1_2022 <- sum(datos_comparacion$t_votos_v1_2022, na.rm = TRUE)
total_votos_v2_2022 <- sum(datos_comparacion$t_votos_v2_2022, na.rm = TRUE)

# Calcular votos de Petro
petro_v1_2018 <- sum(datos_comparacion$Petro_v1_2018, na.rm = TRUE)
petro_v2_2018 <- sum(datos_comparacion$Petro_v2_2018, na.rm = TRUE)
petro_v1_2022 <- sum(datos_comparacion$Petro_v1_2022, na.rm = TRUE)
petro_v2_2022 <- sum(datos_comparacion$Petro_v2_2022, na.rm = TRUE)

# Crear tabla de participaci√≥n electoral
resumen <- tibble(
  Indicador = c(
    "Total Votos 2018 - Primera Vuelta",
    "Total Votos 2018 - Segunda Vuelta",
    "Total Votos 2022 - Primera Vuelta",
    "Total Votos 2022 - Segunda Vuelta"
  ),
  Valor = c(
    total_votos_v1_2018,
    total_votos_v2_2018,
    total_votos_v1_2022,
    total_votos_v2_2022
  ),
  `Proporci√≥n Petro (%)` = c(
    (petro_v1_2018 / total_votos_v1_2018) * 100,
    (petro_v2_2018 / total_votos_v2_2018) * 100,
    (petro_v1_2022 / total_votos_v1_2022) * 100,
    (petro_v2_2022 / total_votos_v2_2022) * 100
  )
)

resumen %>% 
  mutate(
    Valor = comma(Valor),
    `Proporci√≥n Petro (%)` = paste0(round(`Proporci√≥n Petro (%)`, 2), "%")
  ) %>% 
  kbl(align = c("l", "r", "r")) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover"),
    full_width = FALSE,
    position = "left",
    font_size = 12
  ) %>% 
  column_spec(1, bold = TRUE, width = "18em") %>% 
  column_spec(2, width = "8em") %>% 
  column_spec(3, width = "10em", color = "white", background = "#3498db") %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50")
```

## Petro frente a sus contrincantes

Petro obtuvo un crecimiento significativo respecto a su apoyo, en primera vuelta pas√≥ de **1.25 millones de votos a 2.24 millones**, representando un incremento notable del **78.79%,** en segunda vuelta, aunque el crecimiento fue menor en t√©rminos porcentuales **(31.59%)**, mantuvo esta tendencia positiva; en contraste, sus contrincantes directos en ambas elecciones mostraron crecimientos mucho m√°s modestos, apenas **6.87%** en primera vuelta y **14.81%** en segunda vuelta.

La distinci√≥n es clara, Petro logr√≥ expandir considerablemente su base electoral en la capital y el departamento circundante entre ambas contiendas, consolidando un apoyo que **casi se duplic√≥ en la primera ronda electoral** mientras que Duque y Hern√°ndez mantuvieron cifras relativamente estables.

```{r tabla_agregada_mejorada}
# Crear tabla resumen con m√©tricas adicionales
tabla_cundinamarca_larga <- tibble(
  Regi√≥n = rep("Cundinamarca", 4),
  Candidato = c("Gustavo Petro", "Gustavo Petro", 
                "Contrincante (Duque 2018 / Hern√°ndez 2022)", 
                "Contrincante (Duque 2018 / Hern√°ndez 2022)"),
  Vuelta = rep(c("Primera Vuelta", "Segunda Vuelta"), 2),
  
  `2018` = c(
    sum(datos_comparacion$Petro_v1_2018, na.rm = TRUE),
    sum(datos_comparacion$Petro_v2_2018, na.rm = TRUE),
    sum(datos_comparacion$Duque_v1_2018, na.rm = TRUE),
    sum(datos_comparacion$Duque_v2_2018, na.rm = TRUE)
  ),
  
  `2022` = c(
    sum(datos_comparacion$Petro_v1_2022, na.rm = TRUE),
    sum(datos_comparacion$Petro_v2_2022, na.rm = TRUE),
    sum(datos_comparacion$Hernandez_v1_2022, na.rm = TRUE),
    sum(datos_comparacion$Hernandez_v2_2022, na.rm = TRUE)
  )
) %>%
  mutate(
    `Œî Absoluta` = `2022` - `2018`,
    `Œî %` = ((`2022` - `2018`) / `2018`) * 100
  )

# Mostrar tabla formateada
tabla_cundinamarca_larga %>%
  mutate(
    `2018` = comma(`2018`),
    `2022` = comma(`2022`),
    `Œî Absoluta` = paste0(ifelse(`Œî Absoluta` > 0, "+", ""), comma(`Œî Absoluta`)),
    `Œî %` = paste0(ifelse(`Œî %` > 0, "+", ""), round(`Œî %`, 2), "%")
  ) %>%
  knitr::kable(
    align = c("l", "l", "l", "r", "r", "r", "r")
  ) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered")) %>%
  row_spec(1:2, background = "#d4edda") %>%  # Color suave para Petro
  row_spec(3:4, background = "#f8d7da")      # Color suave para contrincantes
```

## Resultados por municipio

Bogot√°, con 617 puestos de votaci√≥n (44% del total), lider√≥ el crecimiento absoluto con 433 mil votos adicionales en primera vuelta, aunque su crecimiento porcentual (40.9%) estuvo por debajo del promedio regional.

Los mayores crecimientos porcentuales se concentraron en municipios peque√±os y medianos, destacan casos como El Rosal (169.6%), Guatavita (172.9%), La Pe√±a (178.6%), Supata (155.7%) y Tibirita (151.8%); sin embargo, el impacto real de estos crecimientos es limitado dado el reducido tama√±o electoral de estos territorios, El Rosal, por ejemplo, apenas sum√≥ 2,122 votos nuevos pese a casi triplicar su votaci√≥n.

En el rango intermedio, municipios como Mosquera (+132.6%), Facatativ√° (+96.1%) y Madrid (+97.8%) lograron crecimientos significativos tanto en t√©rminos porcentuales como absolutos, consolid√°ndose como bastiones regionales. Soacha, el segundo municipio m√°s poblado, aunque su crecimiento porcentual fue modesto (48.7% en primera vuelta), su peso demogr√°fico limitado en comparaci√≥n con Bogot√° refleja una din√°mica metropolitana diferenciada.

```{r tabla_municipios_detallada}
resumen_municipios <- datos_comparacion %>% 
  filter(ambos) %>% 
  group_by(mpio) %>% 
  summarise(
    `N¬∞ Puestos` = n(),
    
    # Petro Primera Vuelta
    `Petro 2018 V1` = sum(Petro_v1_2018, na.rm = TRUE),
    `Petro 2022 V1` = sum(Petro_v1_2022, na.rm = TRUE),
    `Œî Abs V1` = `Petro 2022 V1` - `Petro 2018 V1`,
    `Œî % V1` = ((`Petro 2022 V1` - `Petro 2018 V1`) / `Petro 2018 V1`) * 100,
    
    # Petro Segunda Vuelta
    `Petro 2018 V2` = sum(Petro_v2_2018, na.rm = TRUE),
    `Petro 2022 V2` = sum(Petro_v2_2022, na.rm = TRUE),
    `Œî Abs V2` = `Petro 2022 V2` - `Petro 2018 V2`,
    `Œî % V2` = ((`Petro 2022 V2` - `Petro 2018 V2`) / `Petro 2018 V2`) * 100,
    
    # Participaci√≥n
    `Part. Œî %` = mean(var_participacion_v2, na.rm = TRUE)
  ) %>% 
  arrange(desc(`Œî Abs V2`))

# Funci√≥n para aplicar color condicional
color_var <- function(x) {
  case_when(
    x > 0 ~ "#27ae60",   # Verde
    x < 0 ~ "#c0392b",   # Rojo
    TRUE ~ "#2c3e50"     # Gris oscuro
  )
}

resumen_municipios %>% 
  mutate(
    across(c(`Petro 2018 V1`, `Petro 2022 V1`, `Œî Abs V1`,
             `Petro 2018 V2`, `Petro 2022 V2`, `Œî Abs V2`), ~comma(.x)),
    `Œî % V1` = paste0(ifelse(`Œî % V1` > 0, "+", ""), round(`Œî % V1`, 1), "%"),
    `Œî % V2` = paste0(ifelse(`Œî % V2` > 0, "+", ""), round(`Œî % V2`, 1), "%"),
    `Part. Œî %` = paste0(ifelse(`Part. Œî %` > 0, "+", ""), round(`Part. Œî %`, 1), "%")
  ) %>% 
  kbl(align = c("l", rep("r", 10))) %>% 
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    position = "left",
    font_size = 13
  ) %>% 
  column_spec(1, bold = TRUE, width = "12em") %>% 
  column_spec(6, 
    color = spec_color(resumen_municipios$`Œî % V1`, 
                       begin = 0.3, end = 0.9, 
                       option = "D", direction = 1)
  ) %>% 
  column_spec(10, 
    color = spec_color(resumen_municipios$`Œî % V2`, 
                       begin = 0.3, end = 0.9, 
                       option = "D", direction = 1)
  ) %>% 
  column_spec(11, 
    color = spec_color(resumen_municipios$`Part. Œî %`, 
                       begin = 0.3, end = 0.9, 
                       option = "D", direction = 1)
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  scroll_box(width = "100%", height = "500px")
```

------------------------------------------------------------------------

# An√°lisis a Nivel Puesto de Votaci√≥n

Para 2022, Cundinamarca y Bogot√° contaron con **1.404** **puestos de votaci√≥n** habilitados por la Registradur√≠a, distribuidos en 1**16 municipios m√°s la capital colombiana, que concentra** **901** de ellos, m√°s del **50%** del total. Le siguen Soacha con 52 puestos, Fusagasug√° con 21, Facatativ√° con 18 y Girardot con 17; en el otro extremo se encuentran **33 municipios con solo 1 puesto de votaci√≥n**.

Esta distribuci√≥n refleja la marcada concentraci√≥n demogr√°fica y electoral de la regi√≥n, Bogot√°, como n√∫cleo urbano principal, alberga pr√°cticamente dos tercios de los puestos de votaci√≥n, lo que evidencia su peso determinante en los resultados electorales del departamento. La brecha con los municipios aleda√±os es considerable, incluso Soacha, el segundo municipio m√°s poblado y que funciona como √°rea metropolitana de la capital, apenas alcanza 52 puestos, menos del **6% del total**, lo que demuestra que cualquier estrategia electoral en la regi√≥n debe necesariamente priorizar a Bogot√°, donde se decide la mayor parte del resultado.

## Correlaci√≥n de Votos 2018 vs 2022

Este gr√°fico compara puesto por puesto el desempe√±o de Petro en segunda vuelta entre ambas elecciones. Cada punto representa un puesto de votaci√≥n: en el eje horizontal est√° su votaci√≥n en 2018, en el vertical la de 2022. La l√≠nea punteada marca el equilibrio: si un puesto cayera exactamente sobre ella, significar√≠a que Petro obtuvo los mismos votos en ambos a√±os.

**La mayor√≠a de los puntos se alinean alrededor de la diagonal**, lo que indica que los territorios donde Petro obtuvo m√°s votos inicialmente tendieron tambi√©n a registrar mayores niveles en 2022. En t√©rminos sustantivos, el crecimiento electoral aparece m√°s como un proceso de **ampliaci√≥n sobre bases previas** que como una redistribuci√≥n territorial del apoyo.

El √∫nico punto divergente corresponde al puesto Censoferia Exposicion en Bogot√°, que pese a su enorme volumen electoral registr√≥ una ca√≠da del 16,9% entre 2018 y 2022, reflejando la naturaleza at√≠pica de los puestos de censo y no un cambio territorial en el apoyo electoral.

```{r correlacion_petro_interactivo, echo=FALSE}
library(plotly)

p <- datos_comparacion %>% 
  filter(ambos) %>% 
  ggplot(
    aes(
      x = Petro_v2_2018,
      y = Petro_v2_2022,
      text = paste0(
        "<b>Puesto:</b> ", puesto_nom, "<br>",
        "<b>Municipio:</b> ", mpio, "<br>",
        "<b>Votos 2018:</b> ", comma(Petro_v2_2018), "<br>",
        "<b>Votos 2022:</b> ", comma(Petro_v2_2022), "<br>",
        "<b>Variaci√≥n (%):</b> ", round(var_Petro_v2, 1)
      )
    )
  ) +
  geom_point(
    aes(color = var_Petro_v2, size = t_votos_v2_2022),
    alpha = 0.85,
    stroke = 0.4
  ) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black") +
  scale_color_gradient2(
    low = "#8B0000",      # rojo fuerte
    mid = "#FFFFFF",      # blanco puro
    high = "#003300",     # verde oscuro
    midpoint = 0
  ) +
  scale_size_continuous(range = c(4, 10)) +
  labs(
    x = "Votos Petro 2018 (2da vuelta)",
    y = "Votos Petro 2022 (2da vuelta)"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "none",
    panel.grid.minor = element_blank()
  )

ggplotly(p, tooltip = "text")

```

## Mayores Ganancias de Petro

Estos diez puestos registraron las mayores variaciones absolutas en el voto por Petro al comparar las rondas finales de 2018 y 2022, concentradas exclusivamente en Bogot√° y , particularmente, en puestos ubicados en zonas de expansi√≥n urbana y periferias populares como El Rinc√≥n B, Ciudadela El Porvenir, Recreo Michelsen y Portal Usme. Estos territorios combinaron aumentos muy elevados en t√©rminos absolutos y porcentuales, el crecimiento electoral no se origin√≥ en los centros tradicionales de votaci√≥n sino en √°reas de reciente densificaci√≥n poblacional.

```{r top_ganancias}
datos_comparacion %>% 
  filter(ambos, !is.na(var_abs_Petro_v2)) %>% 
  arrange(desc(var_abs_Petro_v2)) %>% 
  head(10) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `2018` = Petro_v2_2018,
    `2022` = Petro_v2_2022,
    `Ganancia` = var_abs_Petro_v2,
    `Var %` = var_Petro_v2
  ) %>% 
  mutate(
    across(c(`2018`, `2022`, Ganancia), ~comma(.x)),
    `Var %` = paste0("+", round(`Var %`, 1), "%")
  ) %>% 
  kbl(align = c("l", "l", rep("r", 4))) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover"),
    full_width = FALSE,
    font_size = 12
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#27ae60") %>% 
  column_spec(1:2, bold = TRUE, width = "10em") %>% 
  column_spec(3:6, width = "7em")
```

## Mayores P√©rdidas de Petro

No todo fue crecimiento, las mayores p√©rdidas de Petro tambi√©n se concentran exclusivamente en Bogot√°, el caso m√°s significativo es el Puesto Censoferia Exposici√≥n, que registra la mayor ca√≠da absoluta (-7.942 votos), aunque su magnitud responde en gran medida a su tama√±o dentro del sistema electoral, pues, este puesto concentra votaci√≥n altamente m√≥vil y menos territorializada. Varias de las reducciones m√°s fuertes como El Rinc√≥n, Las Orqu√≠deas, La Toscana Lisboa o Sabana de Tibabuyes se ubican en sectores del noroccidente y occidente de la ciudad.

```{r top_perdidas}
datos_comparacion %>% 
  filter(ambos, !is.na(var_abs_Petro_v2)) %>% 
  arrange(var_abs_Petro_v2) %>% 
  head(10) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `2018` = Petro_v2_2018,
    `2022` = Petro_v2_2022,
    `P√©rdida` = var_abs_Petro_v2,
    `Var %` = var_Petro_v2
  ) %>% 
  mutate(
    across(c(`2018`, `2022`, P√©rdida), ~comma(.x)),
    `Var %` = paste0(round(`Var %`, 1), "%")
  ) %>% 
  kbl(align = c("l", "l", rep("r", 4))) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover"),
    full_width = FALSE,
    font_size = 12
  ) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#c0392b") %>% 
  column_spec(1:2, bold = TRUE, width = "10em") %>% 
  column_spec(3:6, width = "7em")
```

## Puestos que Cambiaron de Ganador entre elecciones (Flips)

En la primera vuelta de 2018 Duque lideraba 341 puestos, Fajardo 333 y Petro 317, reflejando un escenario competitivo sin predominio claro, para 2022, en cambio, el patr√≥n cambia, Petro pasa a encabezar 611 puestos, casi duplicando su presencia territorial, mientras Hern√°ndez concentra 322 y Guti√©rrez queda reducido a un n√∫mero marginal. La segunda vuelta confirma un cambio m√°s estructural que abrupto. Petro ya era competitivo en 2018, cuando gan√≥ 544 puestos frente a 447 de Duque, pero en 2022 ampl√≠a su dominio hasta 584 puestos mientras la oposici√≥n se reorganiza alrededor de Hern√°ndez con 407.

El cruce de ganadores entre elecciones permite precisar el mecanismo del cambio, Petro conserva pr√°cticamente intacto su territorio, 538 puestos que ya ganaba en 2018 permanecen bajo su liderazgo en 2022. En contraste, la mayor transici√≥n ocurre dentro del bloque opositor, donde 402 puestos pasan de Duque a Hern√°ndez, evidenciando continuidad del voto contrario m√°s que conversi√≥n directa hacia Petro (solo 45 puestos cambian directamente de Duque a Petro).

Esto se complementa con la fuerte estabilidad observada en los extremos territoriales, 314 puestos donde Petro gana sistem√°ticamente en todas las elecciones y vueltas (95% en Bogot√°) y 356 donde nunca se impone, distribuidos regionalmente como bloque opositor persistente, esto indica que la estabilidad del voto favorable no es homog√©nea regionalmente, sino fundamentalmente metropolitana.

```{r analisis_flips}
# Tabla de flips - CONSIDERANDO TODOS LOS CANDIDATOS
flips_completa <- datos_comparacion %>% 
  filter(ambos) %>% 
  mutate(
    # Determinar si Petro gan√≥ en todas las vueltas de ambas elecciones
    petro_gano_todas = (ganador_v1_2018 == "Petro" & ganador_v2_2018 == "Petro" &
                        ganador_v1_2022 == "Petro" & ganador_v2_2022 == "Petro"),
    # Determinar si Petro no gan√≥ en ninguna
    petro_perdio_todas = (ganador_v1_2018 != "Petro" & ganador_v2_2018 != "Petro" &
                          ganador_v1_2022 != "Petro" & ganador_v2_2022 != "Petro")
  ) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `2018 V1` = ganador_v1_2018,
    `2018 V2` = ganador_v2_2018,
    `2022 V1` = ganador_v1_2022,
    `2022 V2` = ganador_v2_2022,
    petro_gano_todas,
    petro_perdio_todas
  ) %>% 
  arrange(Municipio, Puesto)

# Crear √≠ndices para colorear filas
idx_petro_todas <- which(flips_completa$petro_gano_todas)
idx_petro_ninguna <- which(flips_completa$petro_perdio_todas)

# Tabla principal
flips_completa %>% 
  select(-petro_gano_todas, -petro_perdio_todas) %>% 
  kbl(align = c("l", "l", rep("c", 4))) %>% 
  kable_styling(
    bootstrap_options = c("condensed", "hover", "striped"),
    full_width = FALSE,
    font_size = 11
  ) %>% 
  column_spec(1, bold = TRUE, width = "10em") %>% 
  column_spec(2, width = "15em") %>% 
  column_spec(3:6, width = "7em") %>% 
  add_header_above(c(" " = 2, "Ganador 2018" = 2, "Ganador 2022" = 2)) %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  row_spec(idx_petro_todas, background = "#c8e6c9", bold = TRUE) %>% 
  row_spec(idx_petro_ninguna, background = "#ffcdd2") %>% 
  scroll_box(width = "100%", height = "600px")
```

## Mirada espacial de los votos

Este mapa interactivo geolocaliza cada uno de los 994 puestos de votaci√≥n de Cundinamarca y Bogota, muestra visualmente c√≥mo cambi√≥ el voto por Petro en segunda vuelta entre ambas elecciones. Cada c√≠rculo representa un puesto: su tama√±o es proporcional a la participaci√≥n electoral (mientras mayor el n√∫mero de votantes, m√°s grande el punto), y su color indica la magnitud del cambio.

El amarillo domina el mapa. Los puntos en *üü¢ verde oscuro (50% o m√°s)* corresponden a los puestos donde Petro duplic√≥ o triplic√≥ su votaci√≥n. El *üü¢ verde claro (25% a 50%)* se√±ala crecimientos moderados pero significativos. El *üü° amarillo (-25% a 25%)* indica estabilidad relativa. Los pocos puntos en *üü† naranja (-50% a -25%)* y *üî¥ rojo oscuro (-50% o m√°s)*, muestran las p√©rdidas m√°s relevantes. Los puntos en *‚ö´ gris* corresponden a puestos sin informaci√≥n comparable.

Geogr√°ficamente, **Bogot√°** presenta una estructura espacial en zonas. El **sur y centro** muestra predominio absoluto de amarillo con manchas de verde claro, reflejando consolidaci√≥n en territorios ya conquistados en 2018 donde Petro part√≠a de votaciones superiores al 60% y creci√≥ moderadamente. El **occidente** emerge como el territorio de mayor dinamismo, con concentraci√≥n de verdes claros y oscuros que forman un corredor de expansi√≥n hacia los municipios de la Sabana Occidental. El **norte** presenta algunos de los puntos rojos y naranjas del mapa. La **Sabana Occidental** presenta los crecimientos m√°s notables del departamento. Municipios como Madrid, Mosquera, Facatativ√° y Funza exhiben predominio de verdes oscuros y claros, con tasas promedio de expansi√≥n superiores al 100% en primera vuelta y 40% en segunda vuelta.

El mapa es interactivo: se puede hacer clic en cualquier punto para observar el detalle de cada puesto espec√≠fico, y filtrar por municipio usando el selector superior, lo que permite identificar patrones locales con mayor precisi√≥n.

```{r mapa_interactivo, fig.height=10}
# Calcular tama√±os de radio proporcionales a participaci√≥n
datos_mapa <- datos_mapa %>% 
  mutate(
    # Usar votos de segunda vuelta 2022 (o 2018 si no hay 2022)
    votos_referencia = coalesce(t_votos_v2_2022, t_votos_v2_2018, 0),
    # Escalar radius entre 4 y 18 basado en participaci√≥n (ra√≠z cuadrada para mejor visualizaci√≥n)
    radius_scaled = scales::rescale(sqrt(votos_referencia), to = c(4, 18))
  )

# Preparar datos para crosstalk
datos_compartidos <- SharedData$new(
  datos_mapa %>% 
    mutate(
      mpio = ifelse(is.na(mpio), "Sin municipio", mpio),
      puesto_nom = ifelse(is.na(puesto_nom), "Sin nombre", puesto_nom)
    ),
  key = ~id_puesto
)

# Paleta de colores con rangos
pal <- colorBin(
  palette = c("#d73027", "#fc8d59", "#fee08b", "#d9ef8b", "#91cf60", "#1a9850"),
  domain = datos_mapa$var_Petro_v2,
  bins = c(-Inf,-50, -25, 25, 50, 100, Inf),
  na.color = "#808080"
)

# Filtro por municipio
filter_select(
  id = "municipio",
  label = "Selecciona municipio:",
  sharedData = datos_compartidos,
  group = ~mpio,
  multiple = TRUE
)

# Crear el mapa con fondo claro, m√°s grande y puntos proporcionales
leaflet(datos_compartidos, height = 750, width = "100%") %>% 
  # Usar CartoDB Positron para fondo minimalista y claro
  addProviderTiles(providers$CartoDB.Positron) %>%
  addCircleMarkers(
    lng = ~lon,
    lat = ~lat,
    radius = ~radius_scaled,  # Radio variable seg√∫n participaci√≥n
    color = "#2c3e50",  # Borde oscuro para mejor contraste
    fillColor = ~pal(var_Petro_v2),
    fillOpacity = 0.7,
    stroke = TRUE,
    weight = 1.5,
    opacity = 0.9,
    popup = ~paste0(
      "<div style='width:520px; background-color:#ffffff; padding:15px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.15);'>",
      "<h4 style='margin:0 0 10px 0; color:#2c3e50; border-bottom:2px solid #3498db; padding-bottom:8px;'><strong>", puesto_nom, "</strong></h4>",
      "<p style='margin:5px 0; font-size:13px;'><strong>Municipio:</strong> ", mpio, "</p>",
      "<p style='margin:5px 0; font-size:13px;'><strong>ID:</strong> ", id_puesto, "</p>",
      
      ifelse(solo_2018, 
        "<div style='margin:10px 0; padding:10px; background-color:#fff3cd; border-left:4px solid #ffc107; border-radius:4px;'><strong>‚ö†Ô∏è Solo datos 2018</strong></div>",
        ifelse(solo_2022,
          "<div style='margin:10px 0; padding:10px; background-color:#d1ecf1; border-left:4px solid #17a2b8; border-radius:4px;'><strong>‚ÑπÔ∏è Solo datos 2022</strong></div>",
          "")),
      
      "<hr style='margin:15px 0; border:none; border-top:1px solid #ddd;'>",
      
      "<table style='width:100%; border-collapse: collapse; font-size:12px; background-color:#ffffff;'>",
      "<thead>",
      "<tr style='background-color:#34495e; color:white;'>",
      "<th colspan='4' style='padding:10px; text-align:center; border:1px solid #bdc3c7; font-size:13px;'>GUSTAVO PETRO</th>",
      "</tr>",
      "<tr style='background-color:#ecf0f1;'>",
      "<th style='padding:6px; border:1px solid #bdc3c7; font-weight:bold;'></th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>2018</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>2022</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Œî</th>",
      "</tr>",
      "</thead>",
      "<tbody style='background-color:#ffffff;'>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>1¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v1_2018), comma(Petro_v1_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v1_2022), comma(Petro_v1_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Petro_v1) & var_Petro_v1 > 0, "#27ae60", 
               ifelse(!is.na(var_Petro_v1) & var_Petro_v1 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Petro_v1), paste0(ifelse(var_Petro_v1 > 0, "+", ""), round(var_Petro_v1, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>2¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v2_2018), comma(Petro_v2_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Petro_v2_2022), comma(Petro_v2_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Petro_v2) & var_Petro_v2 > 0, "#27ae60", 
               ifelse(!is.na(var_Petro_v2) & var_Petro_v2 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Petro_v2), paste0(ifelse(var_Petro_v2 > 0, "+", ""), round(var_Petro_v2, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "</tbody>",
      "</table>",
      
      "<div style='height:12px;'></div>",
      
      "<table style='width:100%; border-collapse: collapse; font-size:12px; background-color:#ffffff;'>",
      "<thead>",
      "<tr style='background-color:#c0392b; color:white;'>",
      "<th colspan='4' style='padding:10px; text-align:center; border:1px solid #bdc3c7; font-size:13px;'>CONTRINCANTES</th>",
      "</tr>",
      "<tr style='background-color:#ecf0f1;'>",
      "<th style='padding:6px; border:1px solid #bdc3c7; font-weight:bold;'></th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Duque 2018</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Hern√°ndez 2022</th>",
      "<th style='padding:6px; border:1px solid #bdc3c7; text-align:center; font-weight:bold;'>Œî</th>",
      "</tr>",
      "</thead>",
      "<tbody style='background-color:#ffffff;'>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>1¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Duque_v1_2018), comma(Duque_v1_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Hernandez_v1_2022), comma(Hernandez_v1_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Contrincante_v1) & var_Contrincante_v1 > 0, "#27ae60", 
               ifelse(!is.na(var_Contrincante_v1) & var_Contrincante_v1 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Contrincante_v1), paste0(ifelse(var_Contrincante_v1 > 0, "+", ""), round(var_Contrincante_v1, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "<tr style='background-color:#ffffff;'>",
      "<td style='padding:6px; border:1px solid #bdc3c7; background-color:#f8f9fa;'><strong>2¬™ Vuelta</strong></td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Duque_v2_2018), comma(Duque_v2_2018), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; background-color:#ffffff;'>", 
        ifelse(!is.na(Hernandez_v2_2022), comma(Hernandez_v2_2022), "N/A"), "</td>",
      "<td style='padding:6px; border:1px solid #bdc3c7; text-align:right; font-weight:bold; background-color:#ffffff; color:", 
        ifelse(!is.na(var_Contrincante_v2) & var_Contrincante_v2 > 0, "#27ae60", 
               ifelse(!is.na(var_Contrincante_v2) & var_Contrincante_v2 < 0, "#c0392b", "black")), ";'>", 
        ifelse(!is.na(var_Contrincante_v2), paste0(ifelse(var_Contrincante_v2 > 0, "+", ""), round(var_Contrincante_v2, 1), "%"), "N/A"), "</td>",
      "</tr>",
      "</tbody>",
      "</table>",
      
      "<hr style='margin:15px 0; border:none; border-top:1px solid #ddd;'>",
      "<p style='font-size:11px; color:#7f8c8d; margin:0; padding:8px; background-color:#f8f9fa; border-radius:4px;'><strong>Participaci√≥n Œî:</strong> ",
      ifelse(!is.na(var_participacion_v2), 
        paste0(ifelse(var_participacion_v2 > 0, "+", ""), round(var_participacion_v2, 1), "% (2¬™ vuelta)"), 
        "N/A"),
      "</p>",
      
      "</div>"
    ),
    label = ~puesto_nom
  ) %>% 
  addLegend(
  position = "bottomright",
  pal = pal,
  values = ~var_Petro_v2,
  title = "Variaci√≥n Petro<br>2¬™ Vuelta (%)",
  opacity = 0.8,
  labFormat = function(type, cuts, p) {
    cuts <- as.numeric(cuts)

    paste0(
      ifelse(is.infinite(cuts[-length(cuts)]),
             ifelse(cuts[-length(cuts)] < 0, "< ", ""),
             cuts[-length(cuts)]),
      " ‚Äì ",
      ifelse(is.infinite(cuts[-1]),
             ifelse(cuts[-1] > 0, "> ", ""),
             cuts[-1]),
      "%"
    )
  },
  na.label = "Sin datos"
)

```

## Resultados por puestos de votaci√≥n

```{r tabla_datos_completa, results='asis'}

tabla_puestos <- datos_mapa %>% 
  st_drop_geometry() %>% 
  filter(ambos) %>% 
  select(
    Municipio = mpio,
    Puesto = puesto_nom,
    `Petro 2018 V1` = Petro_v1_2018,
    `Petro 2022 V1` = Petro_v1_2022,
    `Œî % V1` = var_Petro_v1,
    `Petro 2018 V2` = Petro_v2_2018,
    `Petro 2022 V2` = Petro_v2_2022,
    `Œî % V2` = var_Petro_v2,
    `Part. Œî %` = var_participacion_v2
  )

valores_color <- tabla_puestos %>% 
  select(`Œî % V1`, `Œî % V2`, `Part. Œî %`) %>% 
  unlist()

# Recorte robusto (percentil 95)
max_abs <- quantile(abs(valores_color), 0.95, na.rm = TRUE)

color_grad <- function(x) {

  # ---- correcci√≥n m√≠nima: evitar NA / Inf ----
  x[!is.finite(x)] <- 0

  intensidad <- abs(x) / max_abs
  intensidad <- pmin(intensidad, 1)
  intensidad <- 0.35 + 0.65 * intensidad
  
  ifelse(
    x > 0,
    col_numeric(c("#66bb6a", "#006400"), domain = c(0.35,1))(intensidad),
    col_numeric(c("#ef5350", "#8B0000"), domain = c(0.35,1))(intensidad)
  )
}

tabla_puestos %>% 
  mutate(
    across(contains("2018") | contains("2022"), ~comma(.x)),
    `Œî % V1` = cell_spec(
      paste0(ifelse(`Œî % V1` > 0, "+", ""), round(`Œî % V1`, 1), "%"),
      color = color_grad(tabla_puestos$`Œî % V1`),
      bold = TRUE
    ),
    `Œî % V2` = cell_spec(
      paste0(ifelse(`Œî % V2` > 0, "+", ""), round(`Œî % V2`, 1), "%"),
      color = color_grad(tabla_puestos$`Œî % V2`),
      bold = TRUE
    ),
    `Part. Œî %` = cell_spec(
      paste0(ifelse(`Part. Œî %` > 0, "+", ""), round(`Part. Œî %`, 1), "%"),
      color = color_grad(tabla_puestos$`Part. Œî %`),
      bold = TRUE
    )
  ) %>% 
  kbl(
    align = c("l", "l", rep("r", 7)),
    escape = FALSE
  ) %>% 
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = TRUE,
    position = "left",
    font_size = 13
  ) %>% 
  column_spec(1, bold = TRUE, width = "10em") %>% 
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  scroll_box(width = "100%", height = "500px")


```

*Nota: El an√°lisis a nivel de puesto de votaci√≥n compara √∫nicamente aquellos puestos que se mantienen consistentes entre las elecciones de 2018 y 2022. Dado que la Registradur√≠a Nacional del Estado Civil no garantiza la permanencia de todos los puntos electorales de una elecci√≥n a otra, en el caso del departamento de Cundinamarca y Bogota DC, √∫nicamente 994 puestos de votaci√≥n coinciden entre ambos per√≠odos.*

------------------------------------------------------------------------

```{r footer, results='asis', echo=FALSE}
cat('
<div style="text-align: center; margin-top: 40px; padding: 20px; background-color: #ecf0f1; border-radius: 8px;">
<strong style="font-size: 16px;">Evoluci√≥n territorial del voto por Gustavo Petro en Cundinamarca y Bogota DC</strong><br>
<span style="font-size: 14px;">Elecciones presidenciales 2018‚Äì2022</span><br>
<em style="font-size: 12px; color: #7f8c8d;">
Centro de Investigaci√≥n en Econom√≠a y Finanzas (CIENFI) ‚Äì Universidad Icesi
</em>
</div>
')
```
