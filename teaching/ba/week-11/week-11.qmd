---
title: "Unidad 7"
subtitle: "Semana 11: Visualizaci√≥n y An√°lisis de Redes (Teor√≠a de Grafos)"
author: "Eduard F. Mart√≠nez Gonz√°lez"
---
  
<a href="mailto:efmartinez@icesi.edu.co" style="color:black;">
<img src="pic/correo.png" alt="Email" width="20" height="20"/> efmartinez@icesi.edu.co
</a>

<a href="https://github.com/eduard-martinez" style="color:black;"> <img src="pic/github.png" alt="Qries" width="20" height="20"/> eduard-martinez</a>

<a href="https://twitter.com/emartigo" style="color:black;"> <img src="pic/twitter.jpg" alt="Qries" width="20" height="20"/> @emartigo</a>

<a href="https://eduard-martinez.github.io" style="color:black;"> <img src="pic/link.png" alt="Qries" width="20" height="20"/> https://eduard-martinez.github.io</a>

# ¬øQu√© es una red?

En Business Analytics, una **red** (o *grafo*) es una representaci√≥n matem√°tica de las **relaciones** entre entidades:

- Cada **nodo (v√©rtice)** representa un agente: persona, empresa, producto, ciudad, etc.  
- Cada **arista (enlace)** representa una relaci√≥n o interacci√≥n entre ellos: amistad, transacci√≥n, flujo de informaci√≥n, etc.  

Las redes permiten analizar fen√≥menos donde la **interdependencia** entre unidades es clave:  

- Comunicaci√≥n dentro de una organizaci√≥n.  
- Recomendaciones de productos.  
- Flujos comerciales entre pa√≠ses.  
- Colaboraciones cient√≠ficas o empresariales.  

::: callout-note
**Idea clave:** Una red combina estructura (nodos y enlaces) y comportamiento (intensidad, direcci√≥n, frecuencia).  
:::

## Tipos de grafos

Los grafos se clasifican seg√∫n la naturaleza de las relaciones que representan.

### Grafo no dirigido
Las conexiones son **bidireccionales**: si A est√° conectado con B, entonces B tambi√©n lo est√° con A.  
üìò Ejemplo: amistad, coautor√≠a, colaboraci√≥n.

Matem√°ticamente:
$$A_{ij} = A_{ji}$$
donde $A_{ij}$ indica la existencia de un v√≠nculo entre los nodos *i* y *j*.

### Grafo dirigido (*d√≠grafo*)
Las conexiones tienen **direcci√≥n**, lo que permite identificar flujos o jerarqu√≠as.  
üìò Ejemplo: seguidores en redes sociales, flujo de informaci√≥n, pagos entre empresas.

$$A_{ij} \neq A_{ji}$$

Un enlace de *i* a *j* no implica necesariamente que exista el de *j* a *i*.

### Grafo ponderado
Cada arista tiene un **peso o intensidad** que mide la fuerza, frecuencia o costo de la relaci√≥n.  
üìò Ejemplo: n√∫mero de transacciones, horas de comunicaci√≥n, volumen comercial.

El grafo se define como:
$$G = (V, E, W)$$
donde $W$ es el conjunto de **pesos asociados a las aristas**.

## Representaci√≥n de una red

Existen tres formas comunes de representar una red:

1. **Lista de aristas (edge list):**
   Cada fila indica una conexi√≥n entre dos nodos:

   ```
   from   to   weight
   Ana   Beto    3
   Ana   Carla   1
   ```
   
2. **Matriz de adyacencia:**
   Matriz cuadrada $A$ donde $A_{ij} = 1$ si *i* est√° conectado con *j*, y 0 si no.

3. **Matriz de incidencia:**
   Representa qu√© aristas inciden en qu√© nodos, √∫til para c√°lculos estructurales.


## M√©tricas de an√°lisis de redes

El objetivo del an√°lisis de redes es **cuantificar la posici√≥n e importancia de los nodos** dentro de la estructura global.

### M√©tricas locales
Miden la **influencia inmediata** de un nodo dentro de su entorno cercano.

- **Grado de centralidad (Degree):**
  N√∫mero de conexiones directas que tiene un nodo.
  $$C_D(i) = \sum_j A_{ij}$$
  Cuanto mayor el grado, mayor la capacidad de interacci√≥n directa.

- **Centralidad de intermediaci√≥n (Betweenness):**
  Mide cu√°ntas veces un nodo act√∫a como **puente** en los caminos m√°s cortos entre otros nodos.
  $$C_B(i) = \sum_{s \neq i \neq t} \frac{\sigma_{st}(i)}{\sigma_{st}}$$
  donde $\sigma_{st}(i)$ es el n√∫mero de caminos m√≠nimos entre *s* y *t* que pasan por *i*.

### M√©tricas globales
Eval√∫an la posici√≥n de un nodo **respecto a toda la red**.

- **Centralidad de cercan√≠a (Closeness):**
  Indica qu√© tan r√°pido puede un nodo llegar a todos los dem√°s.
  $$C_C(i) = \frac{1}{\sum_j d(i,j)}$$
  donde $d(i,j)$ es la distancia m√°s corta entre *i* y *j*.

- **Centralidad de eigenvector:**
  Considera no solo el n√∫mero de conexiones, sino la **importancia de los nodos conectados**.
  $$C_E(i) = \frac{1}{\lambda} \sum_j A_{ij} C_E(j)$$
  donde $\lambda$ es el mayor valor propio de la matriz de adyacencia.

## Propiedades estructurales de la red

- **Distancia promedio:** n√∫mero medio de pasos que separa a dos nodos cualesquiera.  
- **Excentricidad:** distancia m√°xima de un nodo a cualquier otro.  
- **Di√°metro:** m√°xima excentricidad de la red (longitud del camino m√°s largo entre dos nodos).  
- **Densidad:** proporci√≥n de conexiones existentes sobre el total posible.  
  $$D = \frac{2E}{N(N-1)}$$
  donde $E$ es el n√∫mero de aristas y $N$ el n√∫mero de nodos.

## Comunidades y modularidad

Las **comunidades** son subconjuntos de nodos m√°s densamente conectados entre s√≠ que con el resto de la red.

- En `igraph`, pueden detectarse con algoritmos como:
  - `cluster_louvain()` (para grafos ponderados)
  - `cluster_walktrap()`
  - `cluster_fast_greedy()`

- La **modularidad (Q)** mide qu√© tan bien separadas est√°n esas comunidades:
  $$Q = \frac{1}{2m}\sum_{ij}\left[A_{ij} - \frac{k_i k_j}{2m}\right]\delta(c_i, c_j)$$
  donde $c_i$ es la comunidad del nodo *i*.

## Aplicaciones en Business Analytics

- **Redes sociales corporativas:** identificar l√≠deres informales o cuellos de botella en la comunicaci√≥n.  
- **Marketing:** descubrir influenciadores clave.  
- **Log√≠stica:** optimizar rutas o flujos de transporte.  
- **Finanzas:** mapear interdependencias entre bancos o cooperativas.  
- **Open Finance:** analizar relaciones entre clientes y productos financieros.  

::: callout-tip
**Resumen:** El an√°lisis de redes permite traducir interacciones en conocimiento estructural, identificando qui√©n influye, c√≥mo fluye la informaci√≥n y d√≥nde se forman comunidades dentro de un sistema.  
:::

---

# Aplicaci√≥n en R

Para ilustrar el an√°lisis de redes, construiremos un ejemplo con la red de pases de los jugadores de la Selecci√≥n Colombia durante un partido. Cada nodo representa a un jugador, y cada arista dirigida indica un pase de un jugador a otro. El peso de la arista refleja la cantidad de veces que ese pase se repiti√≥ a lo largo del partido.

A partir de esta red podemos responder preguntas como:

	‚Ä¢	¬øQu√© jugadores son los m√°s influyentes en la circulaci√≥n del bal√≥n?
	‚Ä¢	¬øExisten jugadores que act√∫an como puentes entre l√≠neas (defensa, medio y ataque)?
	‚Ä¢	¬øQu√© tan conectada es la red del equipo?

Este ejercicio nos permitir√° visualizar c√≥mo los patrones de interacci√≥n dentro del equipo pueden analizarse con las mismas herramientas que usamos para estudiar redes sociales, empresariales o financieras. En esencia, un equipo de f√∫tbol es tambi√©n un sistema de relaciones, donde la posici√≥n en la red revela liderazgo, dependencia y eficiencia colectiva.

::: callout-tip
**C√≥mo usar este material:** Puedes ejecutar los _chunks_ de R directamente en el navegador gracias a **webR** (seg√∫n tu `_quarto.yml`), sin instalar nada localmente.
:::

## Preparaci√≥n del entorno

El prop√≥sito de este bloque es asegurar un entorno limpio y reproducible. Primero, eliminamos objetos previos que puedan interferir con el an√°lisis. Despu√©s, cargamos los paquetes necesarios para manipulaci√≥n de datos, visualizaci√≥n, generaci√≥n de res√∫menes y ejecuci√≥n de K-means. Con esto, dejamos el entorno preparado para comenzar.

```{webr-r}
# Limpiar el entorno de trabajo
rm(list = ls())

# instalar
install.packages("ggraph")
install.packages("igraph")

# Cargar paquetes
library(tidyverse)   # Manipulaci√≥n y transformaci√≥n de datos
library(igraph)      # Construcci√≥n y an√°lisis de redes
library(ggraph)      # Visualizaci√≥n avanzada de grafos

# Fijar semilla para reproducibilidad
set.seed(123)
```

## Ingesta de datos (carga desde archivo o URL)

En esta secci√≥n realizamos la ingesta de datos, es decir, el proceso de cargar la base que utilizaremos para construir la red de pases de la Selecci√≥n Colombia. Cada fila de la base representa un pase realizado entre dos jugadores durante un partido, con informaci√≥n sobre qui√©n hizo el pase, a qui√©n se dirigi√≥ y cu√°ntas veces se repiti√≥ esa acci√≥n.

Esta estructura de datos nos permitir√° representar el flujo del bal√≥n como un grafo dirigido y ponderado, donde:

	‚Ä¢	Los nodos son los jugadores.
	‚Ä¢	Las aristas son los pases.
	‚Ä¢	El peso de la arista indica la frecuencia del pase.

```{webr-r}
#| warning: false
#| message: false

## generar los datos
source("https://raw.githubusercontent.com/ba-in-r/01-slides/main/week-11/data/week-11.r")

## chuequear objeto
sel_colombia
```

## Tipos de grafos

Este tipo de red solo representa la existencia de conexi√≥n entre dos jugadores, sin importar qui√©n inici√≥ el pase ni cu√°ntas veces ocurri√≥. Se usa cuando el inter√©s es identificar si existe relaci√≥n, no su direcci√≥n ni su intensidad.

```{webr-r}
## No ponderado, no dirigido
no_dir_plot <- graph.adjacency(sel_colombia, mode="undirected" , diag=FALSE)

## plot
plot(no_dir_plot)
```
Aqu√≠ se incorpora la direcci√≥n del pase, lo cual es crucial en contextos din√°micos como el f√∫tbol. Cada flecha representa qui√©n pasa y qui√©n recibe el bal√≥n.

```{webr-r}
## No ponderado, dirigido
dir_plot <- graph.adjacency(sel_colombia, mode="directed" , diag=FALSE)

## plot
plot(dir_plot, edge.arrow.size=0.8)
```

Incorporamos ahora la intensidad del pase (peso), pero tratamos la red como bidireccional: si dos jugadores se pasan el bal√≥n mutuamente, la arista representa la suma de sus interacciones.

```{webr-r}
## Ponderado, no dirigido
pond_no_dir <- graph.adjacency(sel_colombia, weighted = TRUE, mode ="undirected", diag = FALSE)

## plot
plot(pond_no_dir , edge.width=E(pond_no_dir)$weight)
```
Finalmente, representamos la red completa: cada arista tiene una direcci√≥n (qui√©n pasa a qui√©n) y un peso (frecuencia del pase). Este es el tipo de grafo m√°s informativo para analizar patrones de juego y centralidad.

```{webr-r}
## Ponderado, dirigido
pond_dir <- graph.adjacency(sel_colombia, weighted = TRUE, mode ="directed", diag = FALSE)

## plot
plot(pond_dir , edge.width=E(pond_no_dir)$weight ,  edge.arrow.size = 0.8)
```

## Indicadores de centralidad

El grafo por s√≠ solo nos permite visualizar la estructura general del equipo, pero no siempre es suficiente para analizar la influencia de cada jugador. En la pr√°ctica, las redes pueden ser densas y confusas ‚Äî las l√≠neas se sobreponen y es dif√≠cil identificar qui√©n tiene un rol central o de conexi√≥n.

Para eso, usamos los indicadores de centralidad, que cuantifican la importancia de cada nodo (jugador) dentro de la red seg√∫n diferentes criterios. Estas m√©tricas pueden dividirse en tres grupos: medidas locales, medidas globales y medidas agregadas de red.

### Medidas locales

Eval√∫an la posici√≥n de un nodo respecto a su entorno m√°s inmediato, es decir, cu√°ntos v√≠nculos tiene o qu√© tan importante es como intermediario en los flujos de interacci√≥n.

#### Grado de Centralidad (Degree Centrality)

Mide el n√∫mero de conexiones directas de cada jugador. En el contexto futbol√≠stico, un jugador con alto grado de centralidad es aquel que participa en muchas jugadas de pase.

```{webr-r}
degree(no_dir_plot, mode = "all")
```

**Interpretaci√≥n:** Los jugadores con valores m√°s altos son los que tienen mayor participaci√≥n directa en la circulaci√≥n del bal√≥n (por ejemplo, mediocampistas que conectan l√≠neas o defensas que inician las jugadas).

#### Intermediaci√≥n (Betweenness Centrality)

Mide cu√°ntas veces un nodo act√∫a como puente entre otros dos jugadores. Un jugador con alta intermediaci√≥n es esencial para mantener la cohesi√≥n del equipo: si se elimina, la red puede fragmentarse.

```{webr-r}
betweenness(no_dir_plot)
```

**Interpretaci√≥n:** Valores altos indican jugadores que canalizan el juego entre distintas zonas del campo (por ejemplo, James o Mu√±oz como conectores entre defensa y ataque).

### Medidas globales

Eval√∫an la posici√≥n de un jugador respecto a toda la red, considerando distancias, flujos y relevancia relativa dentro del equipo.

#### Cercan√≠a (Closeness Centrality)

Mide qu√© tan r√°pido un jugador puede alcanzar al resto de sus compa√±eros (en promedio). Cuanto mayor la cercan√≠a, m√°s eficiente es su acceso al resto de la red.

```{webr-r}
## Centralidad de cercan√≠a: eficiencia de conexi√≥n global
closeness(no_dir_plot, mode = "all")
```

**Interpretaci√≥n:** Los jugadores con alta cercan√≠a son aquellos que reciben y distribuyen el bal√≥n con pocos intermediarios, facilitando la fluidez del juego.

#### Puntaje de autoridad (Authority Score)

Indica la importancia relativa de un nodo considerando no solo su n√∫mero de conexiones, sino la relevancia de los nodos a los que est√° conectado. En el f√∫tbol, representa a los jugadores m√°s influyentes en el flujo del bal√≥n.

```{webr-r}
## Puntaje de autoridad: influencia relativa de cada nodo
authority.score(no_dir_plot)$vector
```

**Interpretaci√≥n:** Un puntaje alto sugiere que el jugador est√° conectado con otros importantes. En redes dirigidas, esta m√©trica suele identificar a los receptores clave de pases.

### Otras medidas complementarias

Existen tambi√©n m√©tricas que no pertenecen estrictamente a las categor√≠as anteriores, pero ayudan a describir la estructura general de la red.

#### Distancia promedio (Mean Distance)

Mide el n√∫mero medio de pasos necesarios para conectar dos jugadores cualesquiera. Cuanto menor sea la distancia, m√°s compacto y eficiente es el equipo.

```{webr-r}
## Distancia promedio entre jugadores
mean_distance(no_dir_plot)
```

#### Excentricidad (Eccentricity)

Mide la distancia m√°xima desde un jugador al m√°s lejano en la red.

```{webr-r}
## Excentricidad de cada jugador
eccentricity(no_dir_plot, mode = "all")
```

**Interpretaci√≥n:** Jugadores con alta excentricidad est√°n perif√©ricos en el juego; los de baja excentricidad son centrales o muy conectados.

### Medidas agregadas de la red

Estas m√©tricas resumen propiedades estructurales globales: cohesi√≥n, conectividad y redundancia.

#### Di√°metro (Diameter)

Mide la m√°xima excentricidad, es decir, la ruta m√°s larga que conecta dos jugadores.

```{webr-r}
## Di√°metro de la red (camino m√°s largo)
diameter(no_dir_plot)
```

#### Densidad (Density)

Es la proporci√≥n de conexiones efectivas sobre todas las posibles. Indica qu√© tan interconectado est√° el equipo.

```{webr-r}
## Crear grafo binario para medir densidad
sel_colombia_1 <- sel_colombia
for (i in 1:ncol(sel_colombia_1)) {
    for (j in 1:nrow(sel_colombia_1)) {
         sel_colombia_1[j, i] <- ifelse(sel_colombia_1[j, i] > 0, 1, sel_colombia_1[j, i])
    }
}

g_den <- graph.adjacency(sel_colombia_1, mode = "undirected",
                         weighted = NULL, diag = FALSE)

## Calcular densidad
edge_density(g_den)
```

**Interpretaci√≥n:** Una alta densidad indica un equipo cohesionado, donde la mayor√≠a de los jugadores interact√∫an entre s√≠.

### Transitividad (Transitivity)

Mide la proporci√≥n de tri√°ngulos completos en la red, es decir, cu√°ntos grupos de tres jugadores est√°n totalmente conectados.

```{webr-r}
transitivity(no_dir_plot)
```

**Interpretaci√≥n:** Alta transitividad sugiere jugadas triangulares frecuentes (asociaciones cortas y cooperaci√≥n local).

#### Reciprocidad (Reciprocity)

Indica la probabilidad de que si un jugador A le pasa a B, B tambi√©n le devuelva el pase.

```{webr-r}
reciprocity(no_dir_plot) 
```

**Interpretaci√≥n:** La reciprocidad mide la mutualidad de las interacciones, es decir, qu√© tanto los pases van en ambas direcciones (colaboraci√≥n bidireccional).

# Actividad en Clase: Red de Mensajes de WhatsApp

## Objetivo

Aplicar los conceptos de **an√°lisis de redes** vistos en clase para identificar los contactos m√°s influyentes, los intermediarios y la estructura general de comunicaci√≥n dentro de un grupo de mensajes de WhatsApp simulado.

## Instrucciones

  1. Copia y ejecuta los *chunks* de c√≥digo en R (o directamente en tu entorno webR si est√° habilitado). Esto generar√° una base de datos con los mensajes enviados entre un grupo de contactos y construir√° la matriz de adyacencia necesaria para el an√°lisis.

```{webr-r}
## generar los datos
source("https://raw.githubusercontent.com/ba-in-r/01-slides/main/week-11/data/data.r")
```

  2.	Analiza los resultados obtenidos paso a paso.

	3.	Guarda tu c√≥digo y tus respuestas en un √∫nico archivo .qmd o .html.

	4.	Sube tu archivo final a la plataforma Intu antes del cierre de la sesi√≥n.

## Preguntas

**1. Construcci√≥n del grafo:**

	‚Ä¢	Crea un grafo dirigido y ponderado a partir de la base generada (mensajes).
	‚Ä¢	Aseg√∫rate de que las aristas representen la direcci√≥n del mensaje y su frecuencia (peso).

**2. Indicadores de centralidad:**

Calcula al menos tres indicadores de centralidad:

	‚Ä¢	Grado de centralidad (Degree)
	‚Ä¢	Intermediaci√≥n (Betweenness)
	‚Ä¢	Cercan√≠a (Closeness)

**3. Visualizaci√≥n de la red**

Genera una visualizaci√≥n que muestre las relaciones entre los contactos usando:

	‚Ä¢	plot() (visualizaci√≥n b√°sica), o
	‚Ä¢	ggraph() (visualizaci√≥n avanzada con control de color y tama√±o).

**4. Entrega:** Archivo .R con c√≥digo.

Sube tu archivo a Intu con el nombre: Taller7_Apellido_Nombre.qmd
	
	