---
pagetitle: "Workshop 01: Introducción a Datos Espaciales en R"
title: "Centro de Investigación en Economía y Finanzas - CIENFI"
subtitle: "Workshop 01: Introducción a Datos Espaciales en R"
author: 
  name: Eduard Fernando Martínez González
  affiliation: 
output: 
  html_document:
    theme: journal
    toc: yes
    toc_float:
      collapsed: true
---
```{r setup, include=F , cache=F}
## load packages
require(pacman)
p_load(knitr,tidyverse,janitor,rio,skimr,kableExtra,ggthemes,fontawesome,kable)

## opciones para la visualización de gráficos
options(htmltools.dir.version = F)
opts_chunk$set(fig.align="center", fig.height=2 , dpi=200 , fig.width=4 , cache=F , message=F)
```
 
<!--## [1.] Configuración Inicial ##-->
## [1.] Configuración Inicial

Para facilitar la reproducción de este ejercicio en sus propios equipos, puede descargar el siguiente script de R [aquí](https://gitlab.com/lectures-r/big-data-202202/week-10/-/archive/main/week-10-main.zip?path=clase-10).

En este bloque de código se realiza la configuración básica del entorno de trabajo. Para ello se utiliza el paquete `pacman`, que permite cargar múltiples paquetes de forma eficiente. Si un paquete no está instalado, `pacman::p_load()` lo instala automáticamente antes de cargarlo.

```{r , eval=T}
## llamar pacman 
require(pacman)

## llamar y/o instalar librerias
p_load(tidyverse,    ## tidy data
       rio,          ## leer/escribir conjuntos de datos
       sf,           ## datos espaciales
       mapview,      ## visualizaciones
       tidygeocoder, ## geocodificar
       osmdata)      ## packages osm data
```

Cada una de estas librerías cumple un rol importante en el flujo de trabajo para análisis espacial:

`tidyverse`: Facilita la manipulación, exploración y visualización de datos.

`rio`: Permite importar/exportar archivos en múltiples formatos (como .csv, .xlsx, .sav, entre otros).

`sf`: Es el estándar actual para el manejo de datos espaciales vectoriales en R.

`mapview`: Herramienta práctica para visualizar rápidamente objetos espaciales en mapas interactivos.

`tidygeocoder`: Proporciona una interfaz sencilla para convertir direcciones en coordenadas geográficas y viceversa.

`osmdata`: Permite descargar datos vectoriales de OpenStreetMap, como calles, ríos, edificios, entre otros elementos geográficos.

Esta configuración inicial asegura que contamos con todas las herramientas necesarias para realizar análisis geoespaciales y geocodificación dentro de un entorno reproducible.

<!--## [1.] Configuración Inicial ##-->
## [2.] Geocodificar Direcciones

El paquete `tidygeocoder` permite realizar procesos de geocodificación (obtener coordenadas geográficas a partir de direcciones) y geocodificación inversa (obtener direcciones a partir de coordenadas) de forma sencilla y en formato `tidy`, ideal para trabajar con `dplyr` y `tidyverse.`. 

Aunque su función más conocida es `geocode()`, el paquete incluye otras funciones como `geo()` y `reverse_geocode()`, que permiten realizar tareas similares con menor complejidad o desde coordenadas.

A continuación se presentan los principales motores de geocodificación disponibles en `tidygeocoder`, indicando si requieren o no una clave API:

```{r , eval=T , echo=F}
data.frame(
Metodo = c("osm", "arcgis", "google", "census", "tomtom", "bing"),
Motor = c("OpenStreetMap Nominatim","Esri ArcGIS","Google Maps","US Census Bureau","TomTom","Microsoft Bing Maps"),
`Requiere API Key` = c("No", "No", "Sí", "No (solo EE.UU.)", "Sí", "Sí")) %>%
kable()
```

La siguiente línea utiliza la función `geo()` para obtener las coordenadas (latitud y longitud) de una dirección específica. En este caso se utiliza el motor arcgis (de Esri), que no requiere clave API para este tipo de consultas. La función retorna un data.frame con las columnas address, lat y long.

```{r , eval=T}
## obtener las coordenadas de una dirección
geo("Universidad Icesi, Cali, Colombia" , method="arcgis") 
```

### 2.1. `geo` y `sf`

Aquí almacenamos el resultado de la geocodificación en un objeto llamado icesi, y verificamos su clase. Este objeto es inicialmente un data.frame, lo cual permite manipularlo fácilmente o convertirlo en otros formatos, como objetos espaciales.

```{r , eval=T}
## Almacenar la dirección en un objeto
icesi <- geo("Universidad Icesi, Cali, Colombia" , method="arcgis") 
class(icesi)
```

Para trabajar con datos espaciales en R es común utilizar el paquete `sf`, que proporciona una estructura de datos geoespaciales moderna. Aquí usamos `st_as_sf()` para convertir el data.frame en un objeto espacial, indicando qué columnas contienen las coordenadas (long y lat) y especificando el sistema de referencia geográfica WGS 84 (`crs = 4326`).

```{r , eval=T}
## Convertir el objeto a SF
icesi <- st_as_sf(x=icesi , coords=c("long","lat") , crs=4326)
icesi
```

Finalmente, usamos la función `mapview()` para visualizar el punto geocodificado en un mapa interactivo. `mapview` es una herramienta sencilla y potente para inspeccionar visualmente objetos espaciales, añadiendo automáticamente una capa base de `OpenStreetMap`.

```{r , eval=T}
## la función mapview adiciona la capa de OpenStreetMap
mapview(icesi)
```

### 2.2. Geocodificar un vector de direcciones




<!--## [3.] OpenStreetMap ##-->
## [3.] OpenStreetMap

### 3.1. Acerca de OpenStreetMap

[OpenStreetMap (OSM)](https://www.openstreetmap.org/#map=6/4.63/-74.30) es un proyecto colaborativo de mapeo global y de acceso abierto, similar a una “Wikipedia de los mapas”. Fue creado con el objetivo de generar una base de datos geográficos libre y accesible para todos, y se construye con contribuciones de voluntarios que utilizan GPS, imágenes satelitales y otras fuentes abiertas.

OSM es gratuito y está licenciado bajo la [Open Database License (ODbL)](https://www.openstreetmap.org/copyright), lo cual permite su uso, modificación y redistribución con algunas condiciones de atribución.

### 3.2. Librería osmdata en R

En R, el paquete `osmdata` permite acceder directamente a los datos de OSM mediante consultas a la API `Overpass`, la cual filtra y extrae información específica desde la base de datos global.

Con `osmdata` se pueden consultar objetos espaciales como calles, hospitales, estaciones de buses, edificios, parques, ciclovías y mucho más. La librería facilita descargar, transformar y visualizar estos datos en estructuras compatibles con `sf.`

### 3.3. Features y Tags disponibles en OSM

En OpenStreetMap, los elementos geográficos se describen mediante features (categorías generales) y tags (atributos específicos). Para explorar qué categorías (features) existen en OSM, se puede utilizar la función `available_features()`. Esto devuelve un vector con nombres de elementos como highway, building, amenity, landuse, entre otros.

```{r , eval=T}
## Ver features disponibles
available_features() %>% head(20)
```

Cada feature tiene un conjunto de posibles etiquetas (tags). Por ejemplo, si queremos explorar los tipos de amenity (equipamientos):

```{r , eval=T}
## Ver tags de una feature
available_tags("amenity") %>% head(20)
```

Esto devuelve tags como school, hospital, bus_station, cafe, entre otros.

También puede consultar la documentación oficial de features y tags de OSM en este enlace: [Map Features - OSM Wiki](https://wiki.openstreetmap.org/wiki/Map_features)

### 3.4. Descargar Features desde OpenStreetMap

El proceso para descargar datos desde OSM con osmdata incluye 3 pasos fundamentales:

#### 3.4.1. Definir un área geográfica con getbb()

Antes de consultar OSM, es necesario definir una “bounding box” o caja de coordenadas que delimite la zona de interés. Se puede usar el nombre de una ciudad o país:

```{r , eval=T}
opq(bbox = getbb("Cali Colombia"))
```

`getbb()` obtiene automáticamente las coordenadas que encierran el área especificada.

#### 3.4.2. Construir la consulta con add_osm_feature()

Se define el tipo de información que se desea descargar usando una combinación de key y value. Por ejemplo, para obtener restaurantes:

```{r , eval=T}
osm <- opq(bbox = getbb("Cali Colombia")) %>%
       add_osm_feature(key = "amenity", value = "restaurant")
```

El objeto resultante es una consulta a la API de OSM que aún no se ha ejecutado. Su clase es `overpass_query.`

#### 3.4.3. Ejecutar la consulta y convertir a sf

Con `osmdata_sf()` se ejecuta la consulta y se obtiene una lista con objetos espaciales en formato `sf`:

```{r , eval=T}
osm_sf <- osmdata_sf(osm)
```

Este objeto contiene elementos como:

`osm_points`: objetos puntuales (coordenadas)
	
`osm_lines`: líneas (como calles)
	
`osm_polygons`: polígonos (como edificios o parques)

#### 3.4.4. Extraer y visualizar los puntos

Por ejemplo, para obtener solo los puntos de tipo `restaurante`:

```{r , eval=T}
restaurante <- osm_sf$osm_points %>% select(osm_id, name , amenity)
class(restaurante)
```

Y para visualizar el resultado de forma interactiva:

```{r , eval=T}
mapview(restaurante, color = "red")
```

Esto genera un mapa con los puntos representando los restaurantes en Calí, utilizando una base de OpenStreetMap. `mapview` es muy útil para inspecciones visuales rápidas durante la exploración y validación de datos espaciales.

Este flujo permite enriquecer cualquier análisis espacial con datos abiertos actualizados, sin necesidad de descargar archivos manualmente. Además, la integración con `sf` y `mapview` permite realizar análisis y visualización directamente en R.

<!--## [4.] Operaciones Geométricas ##-->
## [4.] Operaciones Geométricas

### 4.1. Librería `sf`

Puede acceder a las viñetas de la librería [sf](https://github.com/r-spatial/sf) así:

```{r , eval=F}
## Help
vignette("sf3")
vignette("sf4")
```

### 4.2. Filtrar Geometrías

```{r , eval=t}
## usando la geometría
granada <- getbb(place_name = "Granada, Cali", 
                 featuretype = "boundary:administrative", 
                 format_out = "sf_polygon")

mapview(granada)
```

```{r , eval=F}
## crop puntos con poligono (opcion 2)
parques_chapi <- st_intersection(x = parques , y = chapinero)

mapview(chapinero,color="red" , alpha.regions=0) + mapview(parques_chapi)

## crop puntos con poligono (opcion 3)
parques_chapi <- parques[chapinero,]

mapview(chapinero,color="red" , alpha.regions=0) + mapview(parques_chapi)
```

### 4.3. Calcular Distancias

```{r , eval=F}
## Distancia a un punto
my_house$dist_cbd <- st_distance(x=my_house , y=cbd)

my_house$dist_cbd %>% head()

## Distancia a muchos puntos
matrix_dist_bus <- st_distance(x=my_house , y=bus_station)

matrix_dist_bus[1,1:5]

min_dist_bus <- apply(matrix_dist_bus , 1 , min)

min_dist_bus %>% head()

my_house$dist_buse = min_dist_bus
```

<!--## [5.] Visualizar Datos Espaciales ##-->
## [5.] Visualizar Datos Espaciales

```{r , eval=F}
## get Bogota-UPZ 
bog <- opq(bbox = getbb("Bogota Colombia")) %>%
       add_osm_feature(key="boundary", value="administrative") %>% 
       osmdata_sf()
bog <- bog$osm_multipolygons %>% subset(admin_level==9 & !osm_id %in% 16011743:16011744)
```

```{r , eval=F}
## basic plot
ggplot() + geom_sf(data=bog)

## plot variable
bog$normal <- rnorm(nrow(bog),100,10)
ggplot() + geom_sf(data=bog , aes(fill=normal))
```

```{r , eval=F}
## plot variable + scale
map <- ggplot() + geom_sf(data=bog , aes(fill=normal)) +
       scale_fill_viridis(option = "A" , name = "Variable")
map 

## add scale_bar
map <- map +
       scalebar(data = bog , dist = 5 , transform = T , dist_unit = "km") +
       north(data = bog , location = "topleft")
map 

## add theme
map <- map + theme_linedraw() + labs(x="" , y="")
map
```

<!----------------->
<!--- Checklist --->
<!----------------->
### **Referencias**

* Lovelace, R., Nowosad, J., & Muenchow, J. (2019). **Geocomputation with R.** [[Ver aquí]](https://geocompr.robinlovelace.net)

  + Cap. 4: Spatial Data Operations
  + Cap. 5: Geometry Operations
  + Cap. 6: Reprojecting geographic data
  + Cap. 11: Statistical learning
  
* Bivand, R. S., Pebesma, E. J., Gómez-Rubio, V., & Pebesma, E. J. (2013). **Applied spatial data analysis with R.** [[Ver aquí]](https://csgillespie.github.io/efficientR/)

  + Cap. 4: Spatial Data Import and Export
  + Cap. 7: Spatial Point Pattern Analysis
  + Cap. 8: Interpolation and Geostatistics  
  